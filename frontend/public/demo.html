<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UDiscovery - Interactive Demo</title>
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Override nav-container from styles.css */
        .nav-container {
            max-width: none !important;
            margin: 0 !important;
            width: 100% !important;
        }
        
        .demo-container {
            margin: 0 auto;
            padding: 1rem 0;
            padding-top: 1rem;
            min-height: 100vh;
            background: #012A42;
        }
        .demo-header {
            text-align: center;
            margin-top: 1rem;
            margin-bottom: 2rem;
        }
        .demo-header h1 {
            color: #6EE7D7;
            margin-bottom: 0.5rem;
        }
        .demo-header p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.1rem;
        }
        .demo-form-section {
            background: #01344F;
            padding: 2.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(110, 231, 215, 0.3);
        }
        .form-options {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .demo-option {
            flex: 1;
            padding: 1.5rem;
            background: white;
            border: 2px solid #5DADE2;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .demo-option:hover {
            border-color: #3A86FF;
            transform: translateY(-2px);
        }
        .demo-option.selected {
            border-color: #3A86FF;
            background: #F0F4F8;
        }
        .demo-option h3 {
            color: #212F45;
            margin-bottom: 0.5rem;
        }
        .demo-option p {
            color: #5DADE2;
            font-size: 0.9rem;
        }
        .custom-goal-input {
            width: 100%;
            min-height: 150px;
            padding: 1rem;
            border: 1.5px solid rgba(110, 231, 215, 0.3);
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            resize: vertical;
            color: #666666;
            background: #ffffff;
        }
        .university-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .form-group label {
            color: #6EE7D7;
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.75rem;
        }
        .form-input,
        .form-textarea {
            width: 100%;
            padding: 0.875rem;
            border: 1.5px solid rgba(110, 231, 215, 0.3);
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            color: #666666;
            background: #ffffff;
            transition: all 0.3s ease;
        }
        select.form-input,
        select#program-level {
            width: 100%;
            padding: 0.875rem;
            border: 1.5px solid rgba(110, 231, 215, 0.3);
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            color: #666666 !important;
            background: #ffffff !important;
            background-color: #ffffff !important;
            transition: all 0.3s ease;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        select.form-input *,
        select#program-level * {
            color: #1a1a1a !important;
            background: #ffffff !important;
            background-color: #ffffff !important;
        }
        .form-input:hover,
        .form-textarea:hover,
        select.form-input:hover {
            border-color: rgba(110, 231, 215, 0.5);
        }
        .form-input:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #6EE7D7;
            box-shadow: 0 0 0 3px rgba(110, 231, 215, 0.2);
            color: #666666;
            background: #ffffff;
        }
        select.form-input:focus,
        select#program-level:focus {
            outline: none;
            border-color: #6EE7D7;
            box-shadow: 0 0 0 3px rgba(110, 231, 215, 0.2);
            color: #666666 !important;
            background: #ffffff !important;
            background-color: #ffffff !important;
        }
        .form-input::placeholder,
        .form-textarea::placeholder {
            color: rgba(1, 42, 66, 0.5);
        }
        select.form-input {
            color: #666666 !important;
            background: #ffffff !important;
            background-color: #ffffff !important;
        }
        select.form-input option,
        select#program-level option {
            color: #666666 !important;
            background: #ffffff !important;
            background-color: #ffffff !important;
        }
        select.form-input option:checked,
        select#program-level option:checked {
            color: #666666 !important;
            background: #ffffff !important;
            background-color: #ffffff !important;
        }
        select.form-input option:hover,
        select#program-level option:hover {
            color: #666666 !important;
            background: #f0f0f0 !important;
            background-color: #f0f0f0 !important;
        }
        input.form-input,
        textarea.form-textarea {
            color: #666666;
            background: #ffffff;
            background-color: #ffffff;
        }
        input.form-input:focus,
        textarea.form-textarea:focus {
            color: #666666;
            background: #ffffff;
            background-color: #ffffff;
        }
        select.form-input:focus {
            color: #1a1a1a !important;
            background: #ffffff !important;
            background-color: #ffffff !important;
        }
        .form-textarea {
            resize: vertical;
            min-height: 120px;
        }
        .submit-demo-btn {
            width: 100%;
            padding: 0.75rem;
            background: #6EE7D7;
            color: #012A42;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .submit-demo-btn:hover {
            background: #5DD6C6;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(110, 231, 215, 0.3);
        }
        .submit-demo-btn:disabled {
            background: rgba(110, 231, 215, 0.3);
            color: rgba(1, 42, 66, 0.5);
            cursor: not-allowed;
        }
        .results-section {
            display: none;
            margin-top: 2rem;
        }
        
        /* Dashboard Layout */
        .dashboard-layout {
            display: flex;
            flex-direction: column;
            gap: 2.5rem;
        }
        
        @media (min-width: 1024px) {
            .dashboard-layout {
                flex-direction: row;
                align-items: flex-start;
                gap: 2.5rem;
            }
        }
        
        /* Left Sidebar */
        .dashboard-sidebar {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        @media (min-width: 1024px) {
            .dashboard-sidebar {
                width: 224px;
                flex-shrink: 0;
            }
        }
        
        .sidebar-section {
            background: #01344F;
            border: 1px solid rgba(110, 231, 215, 0.3);
            border-radius: 8px;
            padding: 1.5rem;
        }
        
        .sidebar-section h3 {
            color: #6EE7D7;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        
        .sidebar-text {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.125rem;
            margin-bottom: 1rem;
        }
        
        .sidebar-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.125rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(110, 231, 215, 0.2);
        }
        
        .sidebar-item:last-child {
            border-bottom: none;
        }
        
        .sidebar-item span:first-child {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
        }
        
        .status-badge.active {
            background: rgba(110, 231, 215, 0.2);
            color: #6EE7D7;
        }
        
        .sidebar-upload-btn {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background: #012A42;
            border: 1px solid rgba(110, 231, 215, 0.3);
            border-radius: 6px;
            color: rgba(255, 255, 255, 0.9);
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 1rem;
        }
        
        .sidebar-upload-btn:hover {
            background: #01425F;
        }
        
        /* Main Content Area */
        .dashboard-main {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        /* KPI Section */
        .kpi-section {
            background: #01344F;
            border: 1px solid rgba(110, 231, 215, 0.3);
            border-radius: 8px;
            padding: 1.5rem;
        }
        
        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .kpi-header h3 {
            color: #6EE7D7;
            font-size: 1.125rem;
            font-weight: 600;
            margin: 0;
        }
        
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .kpi-card {
            background: rgba(110, 231, 215, 0.1);
            border-radius: 6px;
            padding: 1rem;
            text-align: center;
        }
        
        .kpi-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.125rem;
            margin-bottom: 0.5rem;
        }
        
        .kpi-value {
            color: rgba(255, 255, 255, 0.9);
            font-size: 2rem;
            font-weight: 600;
        }
        
        /* Filters Section */
        .filters-section {
            background: #01344F;
            border: 1px solid rgba(110, 231, 215, 0.3);
            border-radius: 8px;
            padding: 1.5rem;
        }
        
        .filters-section h3 {
            color: #6EE7D7;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        @media (min-width: 1024px) {
            .filters-grid {
                grid-template-columns: repeat(12, 1fr);
            }
        }
        
        .filter-row {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        @media (min-width: 1024px) {
            .filter-row:first-child {
                grid-column: span 12;
            }
            .filter-row:not(:first-child) {
                grid-column: span 4;
            }
        }
        
        .filter-select {
            width: 100%;
            padding: 0.75rem;
            border: 1.5px solid rgba(110, 231, 215, 0.3);
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.9);
            background: #012A42;
            transition: all 0.3s ease;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        .filter-select:focus {
            outline: none;
            border-color: #6EE7D7;
            box-shadow: 0 0 0 3px rgba(110, 231, 215, 0.2);
        }
        
        .filter-select:hover {
            border-color: rgba(110, 231, 215, 0.5);
        }
        
        .filter-row label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.125rem;
        }
        
        .threshold-value {
            color: #6EE7D7;
            font-weight: 600;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .slider-label {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.75rem;
        }
        
        .threshold-slider {
            flex: 1;
            height: 8px;
            border-radius: 4px;
            background: #01425F;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .threshold-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #6EE7D7;
            cursor: pointer;
        }
        
        .threshold-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #6EE7D7;
            cursor: pointer;
            border: none;
        }
        
        /* Admission-specific slider color */
        #admission-threshold-slider::-webkit-slider-thumb {
            background: #4B9BFF !important;
        }
        
        #admission-threshold-slider::-moz-range-thumb {
            background: #4B9BFF !important;
        }
        
        .threshold-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #6EE7D7;
            cursor: pointer;
        }
        
        .threshold-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #6EE7D7;
            cursor: pointer;
            border: none;
        }
        
        .filter-input {
            width: 100%;
            padding: 0.5rem;
            background: #012A42;
            border: 1px solid rgba(110, 231, 215, 0.3);
            border-radius: 6px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.875rem;
        }
        
        .filter-input:focus {
            outline: none;
            border-color: #6EE7D7;
            box-shadow: 0 0 0 2px rgba(110, 231, 215, 0.2);
        }
        
        /* Prospects Section */
        .prospects-section {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        @media (min-width: 1024px) {
            .prospects-section {
                flex-direction: row;
            }
        }
        
        .prospects-main {
            flex: 1;
            min-width: 0;
        }
        
        .prospects-main h3 {
            color: #6EE7D7;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        
        .prospects-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            max-height: calc(100vh - 20rem);
            overflow-y: auto;
            padding-right: 0.5rem;
        }
        
        /* Candidate Card */
        .candidate-card {
            background: #01344F;
            border: 1px solid rgba(110, 231, 215, 0.3);
            border-radius: 8px;
            overflow: visible;
            transition: all 0.3s;
            display: block;
            visibility: visible;
            opacity: 1;
            min-height: auto;
        }
        
        .candidate-card:hover {
            border-color: rgba(110, 231, 215, 0.5);
        }
        
        .candidate-card-header {
            padding: 0.25rem;
        }
        
        .candidate-card-main {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .candidate-info {
            flex: 1;
        }
        
        .candidate-name-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
        }
        
        .candidate-name {
            color: #6EE7D7;
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
        }
        
        .propensity-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            background: rgba(110, 231, 215, 0.2);
            color: #6EE7D7;
            font-size: 1.125rem;
        }
        
        .candidate-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.125rem;
            margin-bottom: 0.75rem;
        }
        
        .candidate-interests {
            display: flex !important;
            flex-wrap: wrap !important;
            gap: 0.5rem !important;
        }
        
        .skills-container {
            display: flex !important;
            flex-wrap: wrap !important;
            gap: 0.5rem !important;
            margin-top: 0.75rem !important;
            min-height: 24px !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        .interest-tag {
            padding: 0.25rem 0.5rem;
            background: #012A42 !important;
            border: 1px solid rgba(110, 231, 215, 0.3) !important;
            border-radius: 4px !important;
            color: rgba(255, 255, 255, 0.8) !important;
            font-size: 0.75rem !important;
            display: inline-block !important;
            visibility: visible !important;
            opacity: 1 !important;
            margin: 0 !important;
            line-height: 1.2 !important;
        }
        
        .candidate-expand-btn {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            padding: 0.5rem;
            transition: color 0.3s;
            font-size: 1.2rem;
        }
        
        .candidate-expand-btn:hover {
            color: rgba(255, 255, 255, 0.9);
        }
        
        .candidate-rationale {
            border-top: 1px solid rgba(110, 231, 215, 0.2);
            padding: 1rem;
            background: rgba(1, 42, 66, 0.5);
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        .candidate-rationale h5 {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .candidate-rationale p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.875rem;
            line-height: 1.6;
            margin: 0;
        }
        
        /* Candidate Details View */
        .candidate-details-view {
            padding: 1rem;
            max-height: calc(100vh - 20rem);
            overflow-y: auto;
        }
        
        .candidate-details-header {
            border-bottom: 1px solid rgba(110, 231, 215, 0.2);
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .candidate-detail-section {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid rgba(110, 231, 215, 0.1);
        }
        
        .candidate-detail-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .candidate-detail-section h4 {
            margin-top: 0;
        }
        
        .candidate-detail-section ul {
            margin-top: 0.5rem;
        }
        
        /* Campaign Sidebar */
        .campaign-sidebar {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        @media (min-width: 1024px) {
            .campaign-sidebar {
                width: 320px;
                flex-shrink: 0;
                max-height: calc(100vh - 14rem);
            }
        }
        
        .campaign-buttons {
            background: #01344F;
            border: 1px solid rgba(110, 231, 215, 0.3);
            border-radius: 8px;
            padding: 1rem;
            flex-shrink: 0;
        }
        
        .campaign-buttons h3 {
            color: #6EE7D7;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }
        
        .campaign-btn {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 6px;
            border: 1px solid rgba(110, 231, 215, 0.3);
            background: #012A42;
            color: rgba(255, 255, 255, 0.9);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.125rem;
        }
        
        .campaign-btn:last-child {
            margin-bottom: 0;
        }
        
        .campaign-btn:hover {
            background: #01425F;
        }
        
        .campaign-btn.active {
            background: #6EE7D7;
            color: #012A42;
            border-color: #6EE7D7;
        }
        
        .campaign-btn.active:hover {
            background: #5DD6C6;
        }
        
        .campaign-viewport {
            background: #01344F;
            border: 1px solid rgba(110, 231, 215, 0.3);
            border-radius: 8px;
            padding: 1rem;
            flex: 1;
            overflow-y: auto;
        }
        
        .campaign-placeholder {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.125rem;
            line-height: 1.6;
        }
        
        .campaign-contact-item {
            background: #012A42;
            border: 1px solid rgba(110, 231, 215, 0.2);
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }
        
        .campaign-contact-name {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.125rem;
            margin-bottom: 0.25rem;
        }
        
        .campaign-contact-value {
            color: #6EE7D7;
            font-size: 0.75rem;
        }
        .candidate-item {
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background: rgba(240, 244, 248, 0.1);
            border-left: 4px solid #3A86FF;
            border-radius: 8px;
        }
        .candidate-item h4 {
            color: #F0F4F8;
            margin-bottom: 0.5rem;
            font-size: 1.3rem;
        }
        .candidate-item .rank {
            color: #3A86FF;
            font-weight: 700;
            font-size: 1.5rem;
            margin-right: 1rem;
        }
        .candidate-item .candidate-name {
            color: #F0F4F8;
            font-weight: 600;
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
        }
        .candidate-item .score {
            display: inline-block;
            background: #6EE7D7;
            color: #012A42;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 1rem;
        }
        .candidate-item .probability {
            display: inline-block;
            background: #3A86FF;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-weight: 700;
            font-size: 1.1rem;
            margin-right: 0.5rem;
            margin-bottom: 1rem;
        }
        .candidate-item .propensity-segment {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }
        .candidate-item .propensity-segment.high {
            background: #298E34;
            color: white;
        }
        .candidate-item .propensity-segment.medium {
            background: #6EE7D7;
            color: #012A42;
        }
        .candidate-item .propensity-segment.low {
            background: #f44336;
            color: white;
        }
        .candidate-item .drivers-list {
            list-style: none;
            padding-left: 0;
        }
        .candidate-item .drivers-list li {
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
            line-height: 1.4;
        }
        .candidate-item .drivers-list.positive li {
            background: rgba(76, 175, 80, 0.2);
            border-left: 3px solid #4CAF50;
        }
        .candidate-item .drivers-list.negative li {
            background: rgba(244, 67, 54, 0.2);
            border-left: 3px solid #f44336;
        }
        .candidate-item .assumptions {
            background: rgba(255, 193, 7, 0.2);
            border-left: 3px solid #FFC300;
            padding: 0.75rem;
            border-radius: 4px;
            margin-top: 1rem;
        }
        .candidate-item .section {
            margin-bottom: 1rem;
        }
        .candidate-item .section-label {
            color: #5DADE2;
            font-weight: 600;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            font-size: 0.85rem;
        }
        .candidate-item .section-content {
            color: #F0F4F8;
            line-height: 1.6;
        }
        .loading {
            text-align: center;
            padding: 3rem;
        }
        .loading-spinner {
            border: 4px solid #F0F4F8;
            border-top: 4px solid #3A86FF;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-content {
            max-width: 600px;
            margin: 0 auto;
        }
        .progress-container {
            margin-bottom: 1rem;
        }
        .progress-bar-container {
            width: 100%;
            height: 24px;
            background: rgba(240, 244, 248, 0.3);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 0.5rem;
            border: 1px solid rgba(58, 134, 255, 0.2);
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3A86FF 0%, #5DADE2 100%);
            border-radius: 12px;
            width: 0%;
            transition: width 0.3s ease;
            box-shadow: 0 2px 8px rgba(58, 134, 255, 0.3);
        }
        .progress-percentage {
            font-size: 1.2rem;
            font-weight: 600;
            color: #3A86FF;
            margin-top: 0.5rem;
        }
        .loading-status {
            min-height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s ease;
            color: #FFFFFF !important;
            font-weight: 500;
        }
        .error-message {
            background: #ffe0e0;
            color: #d32f2f;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        .candidates-table {
            width: 100%;
            border-collapse: collapse;
            background: #212F45;
            border-radius: 8px;
            overflow: hidden;
        }
        .candidates-table thead {
            background: #3A86FF;
            color: white;
        }
        .candidates-table th {
            padding: 1rem;
            text-align: center;
            font-weight: 600;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .candidates-table td {
            padding: 1rem;
            border-bottom: 1px solid rgba(240, 244, 248, 0.1);
            color: #F0F4F8;
            text-align: center;
            vertical-align: middle;
        }
        .candidates-table tbody tr:hover {
            background: rgba(58, 134, 255, 0.1);
        }
        .candidates-table tbody tr:last-child td {
            border-bottom: none;
        }
        .position-cell {
            font-weight: 700;
            font-size: 1.2rem;
            color: #6EE7D7;
        }
        .candidate-name-cell {
            font-weight: 600;
            color: #6EE7D7;
            text-align: left;
        }
        .probability-cell {
            font-weight: 700;
            font-size: 1.1rem;
            color: #6EE7D7;
        }
        .contact-cell {
            color: rgba(110, 231, 215, 0.8);
            font-size: 0.9rem;
        }
        .learn-more-btn {
            background: #6EE7D7;
            color: #012A42;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        .learn-more-btn:hover {
            background: #5DD6C6;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(110, 231, 215, 0.3);
        }
        .download-csv-btn {
            background: #6EE7D7;
            color: #012A42;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .download-csv-btn:hover {
            background: #5DD6C6;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(110, 231, 215, 0.3);
        }
        
        .sidebar-upload-btn i,
        .download-csv-btn i,
        .campaign-btn i,
        .nav-link i {
            flex-shrink: 0;
        }
        
        .hidden {
            display: none;
        }
        
        @media (min-width: 640px) {
            .hidden.sm\:inline {
                display: inline;
            }
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            overflow: auto;
        }
        .modal-content {
            background: #01344F;
            margin: 5% auto;
            padding: 0;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(110, 231, 215, 0.3);
        }
        .modal-header {
            background: #012A42;
            color: #6EE7D7;
            padding: 1.5rem;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(110, 231, 215, 0.3);
        }
        .modal-header h3 {
            margin: 0;
            font-size: 1.5rem;
        }
        .close-modal {
            color: white;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background 0.3s;
        }
        .close-modal:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .modal-body {
            padding: 2rem;
            color: #6EE7D7;
        }
        .no-candidates {
            text-align: center;
            padding: 3rem;
            color: #F0F4F8;
            font-size: 1.1rem;
        }
        .continue-journey-section {
            background: #01344F;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            border: 1px solid rgba(110, 231, 215, 0.3);
        }
        .journey-timeline {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1.5rem;
            flex-wrap: wrap;
        }
        .journey-step {
            flex: 1;
            min-width: 250px;
            text-align: center;
            position: relative;
        }
        .journey-step.completed {
            opacity: 0.7;
        }
        .journey-step.active {
            opacity: 1;
        }
        .step-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #6EE7D7;
            color: #012A42;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin: 0 auto 1rem;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(110, 231, 215, 0.3);
        }
        .journey-step.completed .step-icon {
            background: #298E34;
            color: white;
        }
        .step-title {
            color: #6EE7D7;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .step-description {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            line-height: 1.5;
        }
        .timeline-arrow {
            flex: 0 0 auto;
            font-size: 2rem;
            color: #6EE7D7;
            margin: 0 0.5rem;
        }
        .continue-btn {
            background: #6EE7D7;
            color: #012A42;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 1.5rem;
            width: 100%;
        }
        .continue-btn:hover {
            background: #5DD6C6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(110, 231, 215, 0.4);
        }
        .demo-note {
            background: rgba(110, 231, 215, 0.15);
            border-left: 4px solid #6EE7D7;
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1.5rem;
            color: #6EE7D7;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        .admissions-section {
            display: none;
            margin-top: 3rem;
            padding: 2rem;
            background: #01344F;
            border-radius: 8px;
            border: 1px solid rgba(110, 231, 215, 0.3);
        }
        .admissions-section.active {
            display: block;
        }
        .admissions-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        .admissions-header h2 {
            color: white;
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        .admissions-header p {
            color: #5DADE2;
            font-size: 1rem;
        }
        .admissions-form {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        .upload-area {
            border: 3px dashed rgba(110, 231, 215, 0.5);
            border-radius: 8px;
            padding: 3rem;
            text-align: center;
            background: rgba(110, 231, 215, 0.1);
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-area:hover {
            border-color: #6EE7D7;
            background: rgba(110, 231, 215, 0.15);
        }
        .upload-area.dragover {
            border-color: #6EE7D7;
            background: rgba(110, 231, 215, 0.2);
        }
        .upload-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        .upload-text {
            color: #F0F4F8;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }
        .upload-hint {
            color: #5DADE2;
            font-size: 0.9rem;
        }
        .file-input {
            display: none;
        }
        .file-list {
            margin-top: 1.5rem;
        }
        .file-item {
            background: rgba(110, 231, 215, 0.1);
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #6EE7D7;
            border: 1px solid rgba(110, 231, 215, 0.2);
        }
        .file-item-name {
            flex: 1;
        }
        .file-item-remove {
            background: #ff4444;
            color: white;
            border: none;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        .assess-btn {
            background: #6EE7D7;
            color: #012A42;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }
        .assess-btn:hover {
            background: #5DD6C6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(110, 231, 215, 0.3);
        }
        .assess-btn:disabled {
            background: rgba(110, 231, 215, 0.3);
            color: rgba(1, 42, 66, 0.5);
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <nav class="navbar" style="border-bottom: 1px solid rgba(110, 231, 215, 0.2); background: rgba(1, 42, 66, 0.95); backdrop-filter: blur(10px); position: sticky; top: 0; z-index: 50;">
        <div class="nav-container" style="padding: 0.5rem 10rem; display: flex; align-items: center; justify-content: space-between;">
            <div class="nav-logo">
                <img src="images/udiscovery-logo.png" alt="UDiscovery Logo" style="height: 80px; width: auto;" />
            </div>
            <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem;">
                <div style="display: flex; align-items: center; gap: 1.5rem;">
                    <a href="#" id="nav-prospecting" class="nav-link" style="color: #6EE7D7; padding: 0.5rem 0.75rem; font-size: 1.125rem;">Prospecting</a>
                    <a href="#" id="nav-admissions" class="nav-link" style="color: rgba(148, 163, 184, 1); padding: 0.5rem 0.75rem; font-size: 1.125rem;">Admissions</a>
                    <a href="#" id="nav-logout" class="nav-link" style="color: rgba(148, 163, 184, 1); padding: 0.5rem 0.75rem; font-size: 1.125rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i data-lucide="log-out" style="width: 16px; height: 16px;"></i>
                        <span class="hidden sm:inline">Logout</span>
                    </a>
                </div>
                <div id="welcome-message" style="color: rgba(203, 213, 225, 1); padding-right: 0.75rem; font-size: 1.125rem;"></div>
            </div>
        </div>
    </nav>

    <div class="demo-container">
        <div class="demo-form-section" id="university-form-section">
            <h2 style="color: #6EE7D7; margin-bottom: 1.5rem; border-left: 4px solid #6EE7D7; padding-left: 1rem;">Tell Us About Your Program</h2>
            <p style="color: rgba(255, 255, 255, 0.8); margin-bottom: 2rem; font-size: 0.95rem;">Fill in the details about your university program to help us find the best candidates</p>
            
            <form id="university-form" class="university-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="university-name">University Name *</label>
                        <input 
                            type="text" 
                            id="university-name" 
                            name="university-name"
                            class="form-input"
                            placeholder="e.g., Harvard University"
                            required>
                    </div>
                    <div class="form-group">
                        <label for="program-name">Program Name *</label>
                        <input 
                            type="text" 
                            id="program-name" 
                            name="program-name"
                            class="form-input"
                            placeholder="e.g., Master of Education"
                            required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="program-level">Program Level *</label>
                    <select id="program-level" name="program-level" class="form-input" required style="color: #666666; background: #ffffff; background-color: #ffffff;">
                        <option value="" style="color: #666666; background: #ffffff;">Select program level</option>
                        <option value="certificate" style="color: #666666; background: #ffffff;">Certificate</option>
                        <option value="bachelors" style="color: #666666; background: #ffffff;">Bachelor's Degree</option>
                        <option value="masters" style="color: #666666; background: #ffffff;">Master's Degree</option>
                        <option value="doctoral" style="color: #666666; background: #ffffff;">Doctoral Degree</option>
                        <option value="professional" style="color: #666666; background: #ffffff;">Professional Program</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="program-goals">Program Goals & Ideal Candidate Profile *</label>
                    <textarea 
                        id="program-goals" 
                        name="program-goals"
                        class="form-textarea"
                        rows="6"
                        placeholder="Describe your program's mission, goals, and the type of candidates you're looking for. Include information about desired experience, skills, background, diversity goals, and any specific requirements..."
                        required></textarea>
                    <small style="color: rgba(110, 231, 215, 0.7); font-size: 0.85rem; margin-top: 0.5rem; display: block;">
                        Be as detailed as possible - this helps our AI find the best matches
                    </small>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="program-focus">Program Focus Area</label>
                        <input 
                            type="text" 
                            id="program-focus" 
                            name="program-focus"
                            class="form-input"
                            placeholder="e.g., Education Leadership, STEM Education">
                    </div>
                    <div class="form-group">
                        <label for="program-location">Program Location</label>
                        <input 
                            type="text" 
                            id="program-location" 
                            name="program-location"
                            class="form-input"
                            placeholder="e.g., Cambridge, MA">
                    </div>
                </div>

                <div class="form-group">
                    <label for="additional-requirements">Additional Requirements or Preferences</label>
                    <textarea 
                        id="additional-requirements" 
                        name="additional-requirements"
                        class="form-textarea"
                        rows="3"
                        placeholder="Any specific requirements, preferences, or considerations (e.g., work experience minimum, GPA requirements, diversity goals, etc.)"></textarea>
                </div>

                <button type="submit" id="submit-demo-btn" class="submit-demo-btn">
                    ðŸš€ Find Candidates
                </button>
            </form>

            <div id="error-container"></div>
        </div>

        <!-- Admission Results Section -->
        <div id="admission-results-section" class="results-section" style="display: none;">
            <!-- Page Header -->
            <div style="margin-bottom: 1.5rem; margin-top: 0.5rem; margin-left: 10rem; margin-right: 10rem;">
                <h2 style="color: #4B9BFF; margin-bottom: 0.5rem; font-size: 2rem; font-weight: 600;">Admissions Decision Dashboard</h2>
                <p style="color: rgba(148, 163, 184, 1); font-size: 1.125rem; margin: 0;">Decision phase: AI-generated rationale and success predictions</p>
            </div>
            
            <!-- Dashboard Layout: Sidebar + Main Content -->
            <div class="dashboard-layout" style="margin-left: 10rem; margin-right: 10rem;">
                <!-- Left Sidebar -->
                <div class="dashboard-sidebar">
                    <div class="sidebar-section">
                        <h3>Candidates Dataset</h3>
                        <p class="sidebar-text">Admission database is active and updated</p>
                        <div class="sidebar-item">
                            <span>Updated Database Nov. 2025</span>
                            <span class="status-badge active">Active</span>
                        </div>
                    </div>
                    
                    <div class="sidebar-section">
                        <h3>Admission Criteria</h3>
                        <div class="sidebar-item">
                            <span>Academic Excellence</span>
                        </div>
                        <div class="sidebar-item">
                            <span>Professional Experience</span>
                        </div>
                        <div class="sidebar-item">
                            <span>Leadership</span>
                        </div>
                        <div class="sidebar-item">
                            <span>Mission Alignment</span>
                        </div>
                    </div>
                </div>

                <!-- Main Content Area -->
                <div class="dashboard-main">
                    <!-- KPI Results Box -->
                    <div class="kpi-section" style="border-color: rgba(75, 155, 255, 0.25);">
                        <div class="kpi-header">
                            <h3 style="color: #4B9BFF;">Admission Results & KPIs</h3>
                            <button id="download-admission-csv-btn" class="download-csv-btn" style="display: none; background: rgba(75, 155, 255, 0.85);" onclick="downloadAdmissionCSV()">
                                <i data-lucide="download" style="width: 16px; height: 16px;"></i>
                                <span class="hidden sm:inline">Export</span>
                            </button>
                        </div>
                        <div class="kpi-grid" id="admission-kpi-grid">
                            <div class="kpi-card">
                                <div class="kpi-label">Total Reviewed</div>
                                <div class="kpi-value" id="admission-kpi-total" style="color: #4B9BFF;">0</div>
                            </div>
                            <div class="kpi-card">
                                <div class="kpi-label">Accepted</div>
                                <div class="kpi-value" id="admission-kpi-accepted" style="color: #298E34;">0</div>
                            </div>
                            <div class="kpi-card">
                                <div class="kpi-label">Waitlisted</div>
                                <div class="kpi-value" id="admission-kpi-waitlisted" style="color: rgba(255, 195, 0, 0.9);">0</div>
                            </div>
                            <div class="kpi-card">
                                <div class="kpi-label">Rejected</div>
                                <div class="kpi-value" id="admission-kpi-rejected" style="color: #FF5F5F;">0</div>
                            </div>
                        </div>
                    </div>

                    <!-- Filters & Controls -->
                    <div class="filters-section" style="border-color: rgba(75, 155, 255, 0.25);">
                        <h3 style="color: #4B9BFF;">Filters & Controls</h3>
                        <div class="filters-grid">
                            <div class="filter-row">
                                <label>
                                    Acceptance Threshold: <span class="threshold-value" id="admission-threshold-display">75</span>%
                                </label>
                                <div class="slider-container">
                                    <span class="slider-label">0%</span>
                                    <input type="range" id="admission-threshold-slider" min="0" max="100" value="75" class="threshold-slider">
                                    <span class="slider-label">100%</span>
                                </div>
                            </div>
                            <div class="filter-row">
                                <label>Region</label>
                                <select id="admission-region-filter" class="filter-select">
                                    <option value="all">All Regions</option>
                                    <option value="Alabama">Alabama</option>
                                    <option value="Alaska">Alaska</option>
                                    <option value="Arizona">Arizona</option>
                                    <option value="Arkansas">Arkansas</option>
                                    <option value="California">California</option>
                                    <option value="Colorado">Colorado</option>
                                    <option value="Connecticut">Connecticut</option>
                                    <option value="Delaware">Delaware</option>
                                    <option value="Florida">Florida</option>
                                    <option value="Georgia">Georgia</option>
                                    <option value="Hawaii">Hawaii</option>
                                    <option value="Idaho">Idaho</option>
                                    <option value="Illinois">Illinois</option>
                                    <option value="Indiana">Indiana</option>
                                    <option value="Iowa">Iowa</option>
                                    <option value="Kansas">Kansas</option>
                                    <option value="Kentucky">Kentucky</option>
                                    <option value="Louisiana">Louisiana</option>
                                    <option value="Maine">Maine</option>
                                    <option value="Maryland">Maryland</option>
                                    <option value="Massachusetts">Massachusetts</option>
                                    <option value="Michigan">Michigan</option>
                                    <option value="Minnesota">Minnesota</option>
                                    <option value="Mississippi">Mississippi</option>
                                    <option value="Missouri">Missouri</option>
                                    <option value="Montana">Montana</option>
                                    <option value="Nebraska">Nebraska</option>
                                    <option value="Nevada">Nevada</option>
                                    <option value="New Hampshire">New Hampshire</option>
                                    <option value="New Jersey">New Jersey</option>
                                    <option value="New Mexico">New Mexico</option>
                                    <option value="New York">New York</option>
                                    <option value="North Carolina">North Carolina</option>
                                    <option value="North Dakota">North Dakota</option>
                                    <option value="Ohio">Ohio</option>
                                    <option value="Oklahoma">Oklahoma</option>
                                    <option value="Oregon">Oregon</option>
                                    <option value="Pennsylvania">Pennsylvania</option>
                                    <option value="Rhode Island">Rhode Island</option>
                                    <option value="South Carolina">South Carolina</option>
                                    <option value="South Dakota">South Dakota</option>
                                    <option value="Tennessee">Tennessee</option>
                                    <option value="Texas">Texas</option>
                                    <option value="Utah">Utah</option>
                                    <option value="Vermont">Vermont</option>
                                    <option value="Virginia">Virginia</option>
                                    <option value="Washington">Washington</option>
                                    <option value="West Virginia">West Virginia</option>
                                    <option value="Wisconsin">Wisconsin</option>
                                    <option value="Wyoming">Wyoming</option>
                                </select>
                            </div>
                            <div class="filter-row">
                                <label>Experience Range</label>
                                <select id="admission-experience-filter" class="filter-select">
                                    <option value="all">All Experience Levels</option>
                                    <option value="no-exp">No Professional Experience</option>
                                    <option value="0-2">0-2 Years</option>
                                    <option value="2-5">2-5 Years</option>
                                    <option value="5-10">5-10 Years</option>
                                    <option value="10-15">10-15 Years</option>
                                    <option value="15+">Over 15 Years</option>
                                </select>
                            </div>
                            <div class="filter-row">
                                <label>Incoming Industry</label>
                                <select id="admission-industry-filter" class="filter-select">
                                    <option value="all">All Industries</option>
                                    <option value="k12">K-12 Education</option>
                                    <option value="higher-ed">Higher Education</option>
                                    <option value="for-profit">For-Profit Education</option>
                                    <option value="non-profit">Non-Profit/NGO</option>
                                    <option value="edtech">EdTech/Technology</option>
                                    <option value="media">Media & Publishing</option>
                                    <option value="corporate">Corporate Training</option>
                                    <option value="government">Government/Public Sector</option>
                                    <option value="healthcare">Healthcare Education</option>
                                    <option value="consulting">Education Consulting</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Applicants List + Right Panel -->
                    <div class="flex flex-col lg:flex-row gap-4" style="display: flex; flex-direction: row; gap: 1.5rem;">
                        <!-- Applicants List -->
                        <div class="flex-1" style="flex: 1; min-width: 0;">
                            <h3 id="admission-prospects-title" style="color: #4B9BFF; margin-bottom: 1rem; font-size: 1.25rem;">Ranked Candidates (0)</h3>
                            <div class="prospects-list" id="admission-prospects-list" style="max-height: calc(100vh - 20rem); overflow-y: auto;">
                                <!-- Applicants will be rendered here as cards -->
                            </div>
                        </div>

                        <!-- Right Panel - AI Rationale & Decision Actions -->
                        <div class="campaign-sidebar" style="width: 320px; flex-shrink: 0;">
                            <div id="admission-detail-viewport" class="campaign-viewport" style="min-height: 400px;">
                                <p class="campaign-placeholder">Select an applicant to view & decide</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admission Results Section -->
        <div id="admission-results-section" class="results-section" style="display: none;">
            <!-- Page Header -->
            <div style="margin-bottom: 1.5rem; margin-top: 0.5rem; margin-left: 10rem; margin-right: 10rem;">
                <h2 style="color: #4B9BFF; margin-bottom: 0.5rem; font-size: 2rem; font-weight: 600;">Admissions Decision Dashboard</h2>
                <p style="color: rgba(148, 163, 184, 1); font-size: 1.125rem; margin: 0;">Decision phase: AI-generated rationale and success predictions</p>
            </div>
            
            <!-- Dashboard Layout: Sidebar + Main Content -->
            <div class="dashboard-layout" style="margin-left: 10rem; margin-right: 10rem;">
                <!-- Left Sidebar -->
                <div class="dashboard-sidebar">
                    <div class="sidebar-section">
                        <h3>Candidates Dataset</h3>
                        <p class="sidebar-text">Admission database is active and updated</p>
                        <div class="sidebar-item">
                            <span>Updated Database Nov. 2025</span>
                            <span class="status-badge active">Active</span>
                        </div>
                    </div>
                    
                    <div class="sidebar-section">
                        <h3>Admission Criteria</h3>
                        <div class="sidebar-item">
                            <span>Academic Excellence</span>
                        </div>
                        <div class="sidebar-item">
                            <span>Professional Experience</span>
                        </div>
                        <div class="sidebar-item">
                            <span>Leadership</span>
                        </div>
                        <div class="sidebar-item">
                            <span>Mission Alignment</span>
                        </div>
                    </div>
                </div>

                <!-- Main Content Area -->
                <div class="dashboard-main">
                    <!-- KPI Results Box -->
                    <div class="kpi-section" style="border-color: rgba(75, 155, 255, 0.25);">
                        <div class="kpi-header">
                            <h3 style="color: #4B9BFF;">Admission Results & KPIs</h3>
                            <button id="download-admission-csv-btn" class="download-csv-btn" style="display: none; background: rgba(75, 155, 255, 0.85);" onclick="downloadAdmissionCSV()">
                                <i data-lucide="download" style="width: 16px; height: 16px;"></i>
                                <span class="hidden sm:inline">Export</span>
                            </button>
                        </div>
                        <div class="kpi-grid" id="admission-kpi-grid">
                            <div class="kpi-card">
                                <div class="kpi-label">Total Reviewed</div>
                                <div class="kpi-value" id="admission-kpi-total" style="color: #4B9BFF;">0</div>
                            </div>
                            <div class="kpi-card">
                                <div class="kpi-label">Accepted</div>
                                <div class="kpi-value" id="admission-kpi-accepted" style="color: #298E34;">0</div>
                            </div>
                            <div class="kpi-card">
                                <div class="kpi-label">Waitlisted</div>
                                <div class="kpi-value" id="admission-kpi-waitlisted" style="color: rgba(255, 195, 0, 0.9);">0</div>
                            </div>
                            <div class="kpi-card">
                                <div class="kpi-label">Rejected</div>
                                <div class="kpi-value" id="admission-kpi-rejected" style="color: #FF5F5F;">0</div>
                            </div>
                        </div>
                    </div>

                    <!-- Filters & Controls -->
                    <div class="filters-section" style="border-color: rgba(75, 155, 255, 0.25);">
                        <h3 style="color: #4B9BFF;">Filters & Controls</h3>
                        <div class="filters-grid">
                            <div class="filter-row">
                                <label>
                                    Acceptance Threshold: <span class="threshold-value" id="admission-threshold-display" style="color: #4B9BFF;">75</span>%
                                </label>
                                <div class="slider-container">
                                    <span class="slider-label">0%</span>
                                    <input type="range" id="admission-threshold-slider" min="0" max="100" value="75" class="threshold-slider">
                                    <span class="slider-label">100%</span>
                                </div>
                            </div>
                            <div class="filter-row">
                                <label>Region</label>
                                <select id="admission-region-filter" class="filter-select">
                                    <option value="all">All Regions</option>
                                    <option value="Alabama">Alabama</option>
                                    <option value="Alaska">Alaska</option>
                                    <option value="Arizona">Arizona</option>
                                    <option value="Arkansas">Arkansas</option>
                                    <option value="California">California</option>
                                    <option value="Colorado">Colorado</option>
                                    <option value="Connecticut">Connecticut</option>
                                    <option value="Delaware">Delaware</option>
                                    <option value="Florida">Florida</option>
                                    <option value="Georgia">Georgia</option>
                                    <option value="Hawaii">Hawaii</option>
                                    <option value="Idaho">Idaho</option>
                                    <option value="Illinois">Illinois</option>
                                    <option value="Indiana">Indiana</option>
                                    <option value="Iowa">Iowa</option>
                                    <option value="Kansas">Kansas</option>
                                    <option value="Kentucky">Kentucky</option>
                                    <option value="Louisiana">Louisiana</option>
                                    <option value="Maine">Maine</option>
                                    <option value="Maryland">Maryland</option>
                                    <option value="Massachusetts">Massachusetts</option>
                                    <option value="Michigan">Michigan</option>
                                    <option value="Minnesota">Minnesota</option>
                                    <option value="Mississippi">Mississippi</option>
                                    <option value="Missouri">Missouri</option>
                                    <option value="Montana">Montana</option>
                                    <option value="Nebraska">Nebraska</option>
                                    <option value="Nevada">Nevada</option>
                                    <option value="New Hampshire">New Hampshire</option>
                                    <option value="New Jersey">New Jersey</option>
                                    <option value="New Mexico">New Mexico</option>
                                    <option value="New York">New York</option>
                                    <option value="North Carolina">North Carolina</option>
                                    <option value="North Dakota">North Dakota</option>
                                    <option value="Ohio">Ohio</option>
                                    <option value="Oklahoma">Oklahoma</option>
                                    <option value="Oregon">Oregon</option>
                                    <option value="Pennsylvania">Pennsylvania</option>
                                    <option value="Rhode Island">Rhode Island</option>
                                    <option value="South Carolina">South Carolina</option>
                                    <option value="South Dakota">South Dakota</option>
                                    <option value="Tennessee">Tennessee</option>
                                    <option value="Texas">Texas</option>
                                    <option value="Utah">Utah</option>
                                    <option value="Vermont">Vermont</option>
                                    <option value="Virginia">Virginia</option>
                                    <option value="Washington">Washington</option>
                                    <option value="West Virginia">West Virginia</option>
                                    <option value="Wisconsin">Wisconsin</option>
                                    <option value="Wyoming">Wyoming</option>
                                </select>
                            </div>
                            <div class="filter-row">
                                <label>Experience Range</label>
                                <select id="admission-experience-filter" class="filter-select">
                                    <option value="all">All Experience Levels</option>
                                    <option value="no-exp">No Professional Experience</option>
                                    <option value="0-2">0-2 Years</option>
                                    <option value="2-5">2-5 Years</option>
                                    <option value="5-10">5-10 Years</option>
                                    <option value="10-15">10-15 Years</option>
                                    <option value="15+">Over 15 Years</option>
                                </select>
                            </div>
                            <div class="filter-row">
                                <label>Incoming Industry</label>
                                <select id="admission-industry-filter" class="filter-select">
                                    <option value="all">All Industries</option>
                                    <option value="k12">K-12 Education</option>
                                    <option value="higher-ed">Higher Education</option>
                                    <option value="for-profit">For-Profit Education</option>
                                    <option value="non-profit">Non-Profit/NGO</option>
                                    <option value="edtech">EdTech/Technology</option>
                                    <option value="media">Media & Publishing</option>
                                    <option value="corporate">Corporate Training</option>
                                    <option value="government">Government/Public Sector</option>
                                    <option value="healthcare">Healthcare Education</option>
                                    <option value="consulting">Education Consulting</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Applicants List + Right Panel -->
                    <div style="display: flex; flex-direction: row; gap: 1.5rem;">
                        <!-- Applicants List -->
                        <div style="flex: 1; min-width: 0;">
                            <h3 id="admission-prospects-title" style="color: #4B9BFF; margin-bottom: 1rem; font-size: 1.25rem;">Ranked Candidates (0)</h3>
                            <div class="prospects-list" id="admission-prospects-list" style="max-height: calc(100vh - 20rem); overflow-y: auto;">
                                <!-- Applicants will be rendered here as cards -->
                            </div>
                        </div>

                        <!-- Right Panel - AI Rationale & Decision Actions -->
                        <div class="campaign-sidebar" style="width: 320px; flex-shrink: 0;">
                            <div id="admission-detail-viewport" class="campaign-viewport" style="min-height: 400px;">
                                <p class="campaign-placeholder">Select an applicant to view & decide</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="results-section" class="results-section">
            <!-- Page Header -->
            <div style="margin-bottom: 1.5rem; margin-top: 0.5rem; margin-left: 10rem; margin-right: 10rem;">
                <h2 style="color: #6EE7D7; margin-bottom: 0.5rem; font-size: 2rem; font-weight: 600;">Prospecting Dashboard</h2>
                <p style="color: rgba(148, 163, 184, 1); font-size: 1.125rem; margin: 0;">Discovery phase: Ranked candidates by application propensity</p>
            </div>
            
            <!-- Dashboard Layout: Sidebar + Main Content -->
            <div class="dashboard-layout" style="margin-left: 10rem; margin-right: 10rem;">
                <!-- Left Sidebar -->
                <div class="dashboard-sidebar">
                    <div class="sidebar-section">
                        <h3>Input Data</h3>
                        <p class="sidebar-text">Database is active and updated</p>
                        <div class="sidebar-item">
                            <span>Synthetic Prospect Database</span>
                            <span class="status-badge active">Active</span>
                        </div>
                    </div>
                    
                    <div class="sidebar-section">
                        <h3>Training Data</h3>
                        <p class="sidebar-text">Upload datasets to improve predictions</p>
                        <button class="sidebar-upload-btn">
                            <i data-lucide="upload" style="width: 16px; height: 16px;"></i>
                            Upload Dataset
                        </button>
                        <div class="sidebar-item">
                            <span>Demo Training Data</span>
                            <span class="status-badge active">Active</span>
                        </div>
                    </div>
                </div>

                <!-- Main Content Area -->
                <div class="dashboard-main">
                    <!-- KPI Results Box -->
                    <div class="kpi-section">
                        <div class="kpi-header">
                            <h3>Prospecting Results & KPIs</h3>
                            <button id="download-csv-btn" class="download-csv-btn" style="display: none;" onclick="downloadCSV()">
                                <i data-lucide="download" style="width: 16px; height: 16px;"></i>
                                <span class="hidden sm:inline">Export</span>
                            </button>
                        </div>
                        <div class="kpi-grid" id="prospecting-kpi-grid">
                            <div class="kpi-card">
                                <div class="kpi-label">Possible Candidates Prospected</div>
                                <div class="kpi-value" id="prospecting-kpi-total" style="color: #6EE7D7;">0</div>
                            </div>
                            <div class="kpi-card">
                                <div class="kpi-label">General Fit Candidates</div>
                                <div class="kpi-value" id="prospecting-kpi-fit" style="color: #6EE7D7;">0</div>
                            </div>
                            <div class="kpi-card">
                                <div class="kpi-label">High Probability (&gt;<span id="prospecting-threshold-display">40</span>%)</div>
                                <div class="kpi-value" id="prospecting-kpi-high" style="color: #298E34;">0</div>
                            </div>
                        </div>
                    </div>

                    <!-- Filters & Controls -->
                    <div class="filters-section">
                        <h3>Filters & Controls</h3>
                        <div class="filters-grid">
                            <div class="filter-row">
                                <label>
                                    Propensity Threshold: <span class="threshold-value" id="threshold-display">40</span>%
                                </label>
                                <div class="slider-container">
                                    <span class="slider-label">0%</span>
                                    <input type="range" id="threshold-slider" min="0" max="100" value="40" class="threshold-slider">
                                    <span class="slider-label">100%</span>
                                </div>
                            </div>
                            <div class="filter-row">
                                <label>Region</label>
                                <select id="region-filter" class="filter-select">
                                    <option value="all">All Regions</option>
                                    <option value="Alabama">Alabama</option>
                                    <option value="Alaska">Alaska</option>
                                    <option value="Arizona">Arizona</option>
                                    <option value="Arkansas">Arkansas</option>
                                    <option value="California">California</option>
                                    <option value="Colorado">Colorado</option>
                                    <option value="Connecticut">Connecticut</option>
                                    <option value="Delaware">Delaware</option>
                                    <option value="Florida">Florida</option>
                                    <option value="Georgia">Georgia</option>
                                    <option value="Hawaii">Hawaii</option>
                                    <option value="Idaho">Idaho</option>
                                    <option value="Illinois">Illinois</option>
                                    <option value="Indiana">Indiana</option>
                                    <option value="Iowa">Iowa</option>
                                    <option value="Kansas">Kansas</option>
                                    <option value="Kentucky">Kentucky</option>
                                    <option value="Louisiana">Louisiana</option>
                                    <option value="Maine">Maine</option>
                                    <option value="Maryland">Maryland</option>
                                    <option value="Massachusetts">Massachusetts</option>
                                    <option value="Michigan">Michigan</option>
                                    <option value="Minnesota">Minnesota</option>
                                    <option value="Mississippi">Mississippi</option>
                                    <option value="Missouri">Missouri</option>
                                    <option value="Montana">Montana</option>
                                    <option value="Nebraska">Nebraska</option>
                                    <option value="Nevada">Nevada</option>
                                    <option value="New Hampshire">New Hampshire</option>
                                    <option value="New Jersey">New Jersey</option>
                                    <option value="New Mexico">New Mexico</option>
                                    <option value="New York">New York</option>
                                    <option value="North Carolina">North Carolina</option>
                                    <option value="North Dakota">North Dakota</option>
                                    <option value="Ohio">Ohio</option>
                                    <option value="Oklahoma">Oklahoma</option>
                                    <option value="Oregon">Oregon</option>
                                    <option value="Pennsylvania">Pennsylvania</option>
                                    <option value="Rhode Island">Rhode Island</option>
                                    <option value="South Carolina">South Carolina</option>
                                    <option value="South Dakota">South Dakota</option>
                                    <option value="Tennessee">Tennessee</option>
                                    <option value="Texas">Texas</option>
                                    <option value="Utah">Utah</option>
                                    <option value="Vermont">Vermont</option>
                                    <option value="Virginia">Virginia</option>
                                    <option value="Washington">Washington</option>
                                    <option value="West Virginia">West Virginia</option>
                                    <option value="Wisconsin">Wisconsin</option>
                                    <option value="Wyoming">Wyoming</option>
                                </select>
                            </div>
                            <div class="filter-row">
                                <label>Experience Range</label>
                                <select id="experience-filter" class="filter-select">
                                    <option value="all">All Experience Levels</option>
                                    <option value="no-exp">No Professional Experience</option>
                                    <option value="0-2">0-2 Years</option>
                                    <option value="2-5">2-5 Years</option>
                                    <option value="5-10">5-10 Years</option>
                                    <option value="10-15">10-15 Years</option>
                                    <option value="15+">Over 15 Years</option>
                                </select>
                            </div>
                            <div class="filter-row">
                                <label>Incoming Industry</label>
                                <select id="industry-filter" class="filter-select">
                                    <option value="all">All Industries</option>
                                    <option value="k12">K-12 Education</option>
                                    <option value="higher-ed">Higher Education</option>
                                    <option value="for-profit">For-Profit Education</option>
                                    <option value="non-profit">Non-Profit/NGO</option>
                                    <option value="edtech">EdTech/Technology</option>
                                    <option value="media">Media & Publishing</option>
                                    <option value="corporate">Corporate Training</option>
                                    <option value="government">Government/Public Sector</option>
                                    <option value="healthcare">Healthcare Education</option>
                                    <option value="consulting">Education Consulting</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Main Prospects Section -->
                    <div class="prospects-section">
                        <div class="prospects-main">
                            <h3 id="prospects-title">Ranked Prospects (0)</h3>
                            <div class="prospects-list" id="prospects-list">
                                <!-- Candidates will be rendered here as cards -->
                            </div>
                        </div>

                        <!-- Campaign Views Sidebar -->
                        <div class="campaign-sidebar">
                            <div class="campaign-buttons">
                                <h3>Campaign Views</h3>
                                <button class="campaign-btn active" data-view="list">
                                    <i data-lucide="list" style="width: 16px; height: 16px;"></i>
                                    Ranked List
                                </button>
                                <button class="campaign-btn" data-view="email">
                                    <i data-lucide="mail" style="width: 16px; height: 16px;"></i>
                                    Generate Email Campaign
                                </button>
                                <button class="campaign-btn" data-view="sms">
                                    <i data-lucide="message-square" style="width: 16px; height: 16px;"></i>
                                    Generate SMS Campaign
                                </button>
                            </div>
                            <div class="campaign-viewport" id="campaign-viewport">
                                <p class="campaign-placeholder">View detailed prospect information in the main list. Click on a prospect to expand their AI rationale.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admissions Section -->
        <div id="admissions-section" class="admissions-section">
            <div class="admissions-header">
                <h2>ðŸ“‹ Assess Admission Applications</h2>
                <p>Upload admission applications to get AI-powered assessments and recommendations</p>
            </div>
            <div class="admissions-form">
                <div class="upload-area" id="upload-area" onclick="document.getElementById('file-input').click()">
                    <div class="upload-icon">ðŸ“„</div>
                    <div class="upload-text">Click to upload or drag and drop</div>
                    <div class="upload-hint">PDF, DOCX, or TXT files (Max 10MB each)</div>
                    <input type="file" id="file-input" class="file-input" multiple accept=".pdf,.docx,.txt" onchange="handleFileSelect(event)">
                </div>
                <div id="file-list" class="file-list"></div>
                <button id="assess-applications-btn" class="assess-btn" disabled onclick="assessApplications()">
                    ðŸ” Assess Applications
                </button>
                <div id="admissions-results" style="display: none; margin-top: 2rem;">
                    <!-- Admissions assessment results will appear here -->
                </div>
            </div>
        </div>

        <div id="loading-section" class="loading" style="display: none;">
            <div class="loading-spinner"></div>
            <div class="loading-content">
                <div class="progress-container">
                    <div class="progress-bar-container">
                        <div id="progress-bar" class="progress-bar"></div>
                    </div>
                    <div id="progress-percentage" class="progress-percentage">0%</div>
                </div>
                <p id="loading-status" class="loading-status" style="font-size: 1.1rem; margin-top: 1.5rem;">
                    Initializing AI agents...
                </p>
            </div>
        </div>
    </div>

    <script>
        let selectedOption = null;
        const hgseGoal = `Our primary objective is to build a diverse and mission-driven cohort across all Harvard Graduate School of Education (HGSE) master's programs. We are not just looking for academics; we are looking for future **leaders, innovators, and changemakers** who want to have a systemic impact on the field of education.

Ideal candidates often have **3-10 years of professional experience** and come from a wide range of backgrounds, including **K-12 teaching, school administration, non-profit management, education policy, and ed-tech**.

We want to find individuals who demonstrate a deep commitment to **equity, social justice, and innovation**. Your task is to find datasets containing profiles we can analyze for these signals. Look for keywords indicating leadership, initiative, and a desire to solve complex educational problems, such as 'program manager,' 'department head,' 'founder,' 'principal,' or active involvement in 'community engagement,' 'policy writing,' or 'curriculum development'.`;

        // Handle form submission - ensure DOM is ready
        function attachFormHandler() {
            const form = document.getElementById('university-form');
            if (!form) {
                console.error('Form element not found! Retrying...');
                setTimeout(attachFormHandler, 100);
                return;
            }
            
            console.log('Form element found, attaching submit listener');
            form.addEventListener('submit', async (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('=== Form submitted! ===');
            
            // Build comprehensive university goal from form data
            const formData = {
                universityName: document.getElementById('university-name').value,
                programName: document.getElementById('program-name').value,
                programLevel: document.getElementById('program-level').value,
                programGoals: document.getElementById('program-goals').value,
                programFocus: document.getElementById('program-focus').value,
                programLocation: document.getElementById('program-location').value,
                additionalRequirements: document.getElementById('additional-requirements').value
            };
            
            // Save form data to localStorage
            localStorage.setItem('udiscovery_formData', JSON.stringify(formData));
            
            // Update welcome message
            const welcomeMsg = document.getElementById('welcome-message');
            if (welcomeMsg && formData.universityName) {
                welcomeMsg.textContent = `Welcome, ${formData.universityName}!`;
            }
            
            // Build the university goal text
            let universityGoal = `University: ${formData.universityName}\n`;
            universityGoal += `Program: ${formData.programName} (${formData.programLevel})\n`;
            if (formData.programLocation) {
                universityGoal += `Location: ${formData.programLocation}\n`;
            }
            if (formData.programFocus) {
                universityGoal += `Focus Area: ${formData.programFocus}\n`;
            }
            universityGoal += `\nProgram Goals & Ideal Candidate Profile:\n${formData.programGoals}`;
            if (formData.additionalRequirements) {
                universityGoal += `\n\nAdditional Requirements:\n${formData.additionalRequirements}`;
            }
            
            // Show loading, hide form
            document.querySelector('.demo-form-section').style.display = 'none';
            document.getElementById('loading-section').style.display = 'block';
            document.getElementById('results-section').style.display = 'none';
            document.getElementById('error-container').innerHTML = '';
            
            // Start loading progress
            startLoadingProgress();

            try {
                // Create an AbortController for timeout handling
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30 * 60 * 1000); // 30 minute timeout
                
                const response = await fetch('/api/run-demo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ university_goal: universityGoal }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Stop loading progress
                stopLoadingProgress();
                
                // Hide loading, show results
                document.getElementById('loading-section').style.display = 'none';
                
                if (data.success) {
                    // Save results to localStorage
                    localStorage.setItem('udiscovery_results', data.result);
                    localStorage.setItem('udiscovery_timestamp', new Date().toISOString());
                    
                    // Display results
                    displayResults(data.result);
                } else {
                    showError(data.error || 'Failed to generate demo results');
                    document.querySelector('.demo-form-section').style.display = 'block';
                }
            } catch (error) {
                stopLoadingProgress();
                document.getElementById('loading-section').style.display = 'none';
                
                if (error.name === 'AbortError') {
                    showError('Request timed out. The analysis is taking longer than expected. Please try again or contact support.');
                } else {
                    showError(`Failed to run demo: ${error.message}`);
                }
                document.querySelector('.demo-form-section').style.display = 'block';
            }
            });
        }
        
        // Attach form handler when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', attachFormHandler);
        } else {
            attachFormHandler();
        }
        
        // Also add direct click handler as backup
        function attachButtonHandler() {
            const submitBtn = document.getElementById('submit-demo-btn');
            if (submitBtn) {
                console.log('Submit button found, attaching click handler');
                submitBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Button clicked directly!');
                    const form = document.getElementById('university-form');
                    if (form) {
                        form.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
                    }
                });
            } else {
                console.log('Submit button not found, retrying...');
                setTimeout(attachButtonHandler, 100);
            }
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', attachButtonHandler);
        } else {
            attachButtonHandler();
        }

        // Loading progress and status messages
        let loadingInterval = null;
        let progressInterval = null;
        let currentProgress = 0;
        
        const loadingMessages = [
            { progress: 0, message: "ðŸ¤– Initializing AI agents..." },
            { progress: 10, message: "ðŸ“Š Analyzing program requirements and candidate traits..." },
            { progress: 20, message: "ðŸ“‚ Loading candidate dataset..." },
            { progress: 30, message: "ðŸ” Processing candidate profiles..." },
            { progress: 40, message: "ðŸ§  Inferring candidate traits and characteristics..." },
            { progress: 50, message: "ðŸ“ˆ Calculating application probabilities..." },
            { progress: 60, message: "ðŸŽ¯ Identifying key positive and negative drivers..." },
            { progress: 70, message: "âš–ï¸ Ranking candidates by application likelihood..." },
            { progress: 80, message: "âœ¨ Finalizing results and generating insights..." },
            { progress: 90, message: "ðŸŽ‰ Almost done! Preparing your candidate list..." },
            { progress: 95, message: "âœ… Completing final analysis..." }
        ];
        
        function startLoadingProgress() {
            currentProgress = 0;
            const progressBar = document.getElementById('progress-bar');
            const progressPercentage = document.getElementById('progress-percentage');
            const loadingStatus = document.getElementById('loading-status');
            
            // Reset progress
            if (progressBar) progressBar.style.width = '0%';
            if (progressPercentage) progressPercentage.textContent = '0%';
            if (loadingStatus) {
                loadingStatus.textContent = loadingMessages[0].message;
                loadingStatus.style.opacity = '1';
            }
            
            let lastMessageIndex = 0;
            
            // Update progress bar - smooth, even progression
            const startTime = Date.now();
            const targetProgress = 95; // Progress to 95% smoothly, then complete to 100% when API finishes
            const estimatedDuration = 90000; // 90 seconds to reach 95%
            
            progressInterval = setInterval(() => {
                // Calculate smooth progress based on time
                const elapsed = Date.now() - startTime;
                const timeBasedProgress = Math.min((elapsed / estimatedDuration) * targetProgress, targetProgress);
                
                // Ensure we always move forward, but smoothly
                if (timeBasedProgress > currentProgress) {
                    currentProgress = timeBasedProgress;
                } else {
                    // If time-based is behind, add a tiny increment to ensure forward movement
                    currentProgress = Math.min(currentProgress + 0.1, targetProgress);
                }
                
                if (progressBar) progressBar.style.width = currentProgress + '%';
                if (progressPercentage) progressPercentage.textContent = Math.round(currentProgress) + '%';
                
                // Update message based on progress - find the appropriate message for current progress
                for (let i = loadingMessages.length - 1; i >= 0; i--) {
                    if (currentProgress >= loadingMessages[i].progress && i > lastMessageIndex) {
                        lastMessageIndex = i;
                        if (loadingStatus) {
                            loadingStatus.style.opacity = '0';
                            setTimeout(() => {
                                loadingStatus.textContent = loadingMessages[i].message;
                                loadingStatus.style.opacity = '1';
                            }, 150);
                        }
                        break;
                    }
                }
            }, 100);
        }
        
        function stopLoadingProgress() {
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
            
            // Complete the progress bar
            const progressBar = document.getElementById('progress-bar');
            const progressPercentage = document.getElementById('progress-percentage');
            const loadingStatus = document.getElementById('loading-status');
            
            if (progressBar) progressBar.style.width = '100%';
            if (progressPercentage) progressPercentage.textContent = '100%';
            if (loadingStatus) {
                loadingStatus.textContent = 'âœ… Analysis complete!';
            }
        }

        // Store selected files for admissions
        let selectedFiles = [];
        
        // Show admissions section
        function showAdmissionsSection() {
            document.getElementById('results-section').style.display = 'none';
            document.getElementById('admissions-section').classList.add('active');
            // Initialize upload area when section is shown
            initializeUploadArea();
            // Scroll to admissions section
            document.getElementById('admissions-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // Handle file selection
        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            files.forEach(file => {
                if (file.size > 10 * 1024 * 1024) { // 10MB limit
                    alert(`File ${file.name} is too large. Maximum size is 10MB.`);
                    return;
                }
                if (!selectedFiles.find(f => f.name === file.name && f.size === file.size)) {
                    selectedFiles.push(file);
                }
            });
            updateFileList();
        }
        
        // Update file list display
        function updateFileList() {
            const fileList = document.getElementById('file-list');
            const assessBtn = document.getElementById('assess-applications-btn');
            
            if (selectedFiles.length === 0) {
                fileList.innerHTML = '';
                assessBtn.disabled = true;
            } else {
                fileList.innerHTML = selectedFiles.map((file, index) => `
                    <div class="file-item">
                        <span class="file-item-name">ðŸ“„ ${file.name} (${(file.size / 1024).toFixed(1)} KB)</span>
                        <button class="file-item-remove" onclick="removeFile(${index})">Remove</button>
                    </div>
                `).join('');
                assessBtn.disabled = false;
            }
        }
        
        // Remove file
        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFileList();
        }
        
        // Handle drag and drop (initialize when admissions section is shown)
        function initializeUploadArea() {
            const uploadArea = document.getElementById('upload-area');
            if (!uploadArea) return;
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files);
                files.forEach(file => {
                    if (file.size > 10 * 1024 * 1024) {
                        alert(`File ${file.name} is too large. Maximum size is 10MB.`);
                        return;
                    }
                    if (!selectedFiles.find(f => f.name === file.name && f.size === file.size)) {
                        selectedFiles.push(file);
                    }
                });
                updateFileList();
            });
        }
        
        // Assess applications (placeholder for now)
        function assessApplications() {
            if (selectedFiles.length === 0) {
                alert('Please select at least one file to assess.');
                return;
            }
            
            // TODO: Implement backend API call for assessment
            const resultsDiv = document.getElementById('admissions-results');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = `
                <div style="background: rgba(58, 134, 255, 0.1); padding: 2rem; border-radius: 8px; border-left: 4px solid #3A86FF;">
                    <h3 style="color: #3A86FF; margin-bottom: 1rem;">ðŸš§ Assessment Feature Coming Soon</h3>
                    <p style="color: #F0F4F8;">
                        You've selected ${selectedFiles.length} file(s) for assessment. The AI-powered admission application assessment feature is currently under development.
                    </p>
                    <p style="color: #5DADE2; margin-top: 1rem; font-size: 0.9rem;">
                        Files ready: ${selectedFiles.map(f => f.name).join(', ')}
                    </p>
                </div>
            `;
        }
        

        function displayResults(result) {
            // Update welcome message with university name
            const savedFormData = localStorage.getItem('udiscovery_formData');
            if (savedFormData) {
                try {
                    const formData = JSON.parse(savedFormData);
                    const welcomeMsg = document.getElementById('welcome-message');
                    if (welcomeMsg && formData.universityName) {
                        welcomeMsg.textContent = `Welcome, ${formData.universityName}!`;
                    }
                } catch (e) {
                    console.error('Error parsing form data:', e);
                }
            }
            
            const resultsContent = document.getElementById('results-content');
            
            // Get the result text - CrewAI returns result.raw as a string
            let text = '';
            if (typeof result === 'string') {
                text = result;
            } else if (result && typeof result === 'object') {
                // Try different possible attributes
                if (result.raw !== undefined) {
                    text = String(result.raw);
                } else if (result.content !== undefined) {
                    text = String(result.content);
                } else {
                    text = JSON.stringify(result, null, 2);
                }
            } else {
                text = String(result || 'No results generated');
            }

            // Remove markdown code blocks (```...```) but keep the content inside
            text = text.replace(/```[a-z]*\n?/g, '').replace(/```/g, '').trim();
            
            // Extract total processed count from header (e.g., "Processed 1000 candidates across 2 batches")
            let totalProcessed = 0;
            const processedMatch = text.match(/Processed\s+(\d+)\s+candidates/i);
            if (processedMatch) {
                totalProcessed = parseInt(processedMatch[1], 10);
                console.log('Total candidates processed from dataset:', totalProcessed);
            }
            
            // Store total processed count globally
            window.totalCandidatesProcessed = totalProcessed || 0;
            
            // Debug: log what we received
            console.log('Result type:', typeof result);
            console.log('Text length:', text.length);
            console.log('First 1000 chars:', text.substring(0, 1000));

            // Try to parse structured candidates from the text
            const candidates = parseCandidates(text);
            
            // Debug: log parsed candidates
            console.log('Parsed candidates:', candidates);
            console.log('Number of candidates:', candidates.length);
            
            // Filter candidates with probability >= 40%
            const filteredCandidates = candidates.filter(c => {
                if (c.probability !== null && c.probability !== undefined) {
                    return parseFloat(c.probability) >= 0.4;
                }
                return false;
            });
            
            // Sort by probability (highest to lowest)
            filteredCandidates.sort((a, b) => {
                const probA = a.probability !== null && a.probability !== undefined ? parseFloat(a.probability) : 0;
                const probB = b.probability !== null && b.probability !== undefined ? parseFloat(b.probability) : 0;
                return probB - probA; // Descending order (highest first)
            });
            
            // Update ranks based on sorted order
            filteredCandidates.forEach((candidate, index) => {
                candidate.rank = (index + 1).toString();
            });
            
            // Store all candidates globally for filtering
            window.allCandidatesData = candidates;
            window.filteredCandidatesData = filteredCandidates;
            
            // Update KPIs (use filtered candidates - they're already filtered by threshold >= 40%)
            updateProspectingKPIs(filteredCandidates);
            
            // Initialize filters
            initializeFilters();
            
            if (filteredCandidates.length > 0) {
                // Show download CSV button
                const downloadBtn = document.getElementById('download-csv-btn');
                if (downloadBtn) {
                    downloadBtn.style.display = 'flex';
                }
                
                // Render candidates as cards
                renderCandidateCards(filteredCandidates);
                
                // Store candidates globally for modal access
                window.candidatesData = filteredCandidates;
            } else if (candidates.length > 0) {
                // Have candidates but none meet the 40% threshold
                resultsContent.innerHTML = `
                    <div class="no-candidates">
                        <p>Found ${candidates.length} candidates, but none have an application probability of 40% or higher.</p>
                        <p>Try adjusting your search criteria or check the raw results below.</p>
                    </div>
                    <pre style="white-space: pre-wrap; color: #F0F4F8; font-family: 'Inter', sans-serif; line-height: 1.6; margin-top: 2rem;">${escapeHtml(text)}</pre>
                `;
                // Hide download button
                const downloadBtn = document.getElementById('download-csv-btn');
                if (downloadBtn) {
                    downloadBtn.style.display = 'none';
                }
            } else {
                // Fallback to raw text display (but formatted nicely)
                // Show the actual text so we can debug
                const formattedText = text.length > 0 ? text : 'No candidates found in the results.';
                resultsContent.innerHTML = `<pre style="white-space: pre-wrap; color: #F0F4F8; font-family: 'Inter', sans-serif; line-height: 1.6; margin: 0;">${escapeHtml(formattedText)}</pre>`;
                // Hide download button
                const downloadBtn = document.getElementById('download-csv-btn');
                if (downloadBtn) {
                    downloadBtn.style.display = 'none';
                }
            }

            document.getElementById('results-section').style.display = 'block';
        }
        
        // Global state for filtering
        let expandedCandidateIndex = null;
        let currentThreshold = 40;
        let currentView = 'list';
        
        function renderCandidateCards(candidates) {
            console.log('=== renderCandidateCards called ===');
            console.log('Number of candidates:', candidates ? candidates.length : 0);
            console.log('Current expandedCandidateIndex:', expandedCandidateIndex);
            
            const prospectsList = document.getElementById('prospects-list');
            const prospectsTitle = document.getElementById('prospects-title');
            
            if (!prospectsList) {
                console.error('prospects-list element not found!');
                return;
            }
            
            if (!prospectsList) {
                console.error('prospects-list element not found!');
                return;
            }
            
            if (!candidates || candidates.length === 0) {
                prospectsList.innerHTML = `
                    <div class="candidate-card" style="text-align: center; padding: 3rem;">
                        <p style="color: rgba(255, 255, 255, 0.7);">
                            No prospects match your current filters. Adjust the threshold or filter criteria.
                        </p>
                    </div>
                `;
                if (prospectsTitle) {
                    prospectsTitle.textContent = 'Ranked Prospects (0)';
                }
                return;
            }
            
            if (prospectsTitle) {
                prospectsTitle.textContent = `Ranked Prospects (${candidates.length})`;
            }
            
            console.log('About to render', candidates.length, 'candidates');
            console.log('prospectsList element:', prospectsList);
            
            const cardsHTML = candidates.map((candidate, index) => {
                // Use the original index from the filtered array, not the display index
                const candidateIndex = index;
                const isExpanded = expandedCandidateIndex === candidateIndex;
                
                if (isExpanded) {
                    console.log(`Rendering EXPANDED candidate ${candidateIndex}:`, {
                        name: candidate.name,
                        hasBackground: !!candidate.background,
                        background: candidate.background ? candidate.background.substring(0, 100) : 'none',
                        hasWhyMatch: !!candidate.whyMatch,
                        hasPositiveDrivers: !!candidate.positiveDrivers,
                        hasNegativeDrivers: !!candidate.negativeDrivers
                    });
                }
                
                // Ensure we have at least a name to display - check multiple possible fields
                const candidateName = candidate.name || candidate.fullName || candidate.candidateName || `Candidate ${candidateIndex + 1}`;
                
                // Calculate probability - try multiple sources
                let probability = '0';
                if (candidate.probability !== null && candidate.probability !== undefined) {
                    const prob = parseFloat(candidate.probability);
                    probability = (prob > 1 ? prob : prob * 100).toFixed(1);
                } else if (candidate.score) {
                    const scoreParts = candidate.score.split('/');
                    if (scoreParts[0]) {
                        probability = parseFloat(scoreParts[0]).toFixed(1);
                    }
                }
                
                const contactInfo = extractContactInfo(candidate);
                
                // Extract location, experience, GPA, degree from background - try multiple sources
                const background = candidate.background || candidate.rationale || candidate.whyMatch || candidate.description || '';
                
                // Use location from agent output if available, otherwise extract from background
                let location = candidate.location || extractLocation(background) || extractLocation(candidate.background || '') || 'Not specified';
                // Convert state abbreviation to full state name
                location = getFullStateName(location);
                const experience = extractExperience(background) || extractExperience(candidate.background || '') || 'Not specified';
                const gpa = extractGPA(background) || extractGPA(candidate.background || '') || null;
                const degree = extractDegree(background) || extractDegree(candidate.background || '') || null;
                
                // Use candidate.background if available, otherwise try to construct from other fields
                let candidateBackground = candidate.background || '';
                if (!candidateBackground && candidate.description) {
                    candidateBackground = candidate.description;
                }
                // If still no background, try to get it from the parsed data
                if (!candidateBackground) {
                    candidateBackground = background;
                }
                
                return `
                    <div class="candidate-card" onclick="window.showCandidateDetails(${candidateIndex})" style="cursor: pointer;">
                        <div class="candidate-card-header">
                            <div class="candidate-card-main">
                                <div class="candidate-info">
                                    <div class="candidate-name-row">
                                        <h4 class="candidate-name">${escapeHtml(candidateName)}</h4>
                                        <span class="propensity-badge">${probability}% propensity</span>
                                    </div>
                                    <div class="candidate-meta" style="display: flex; flex-wrap: wrap; gap: 0.5rem; color: rgba(255, 255, 255, 0.7); font-size: 1rem; margin-top: 0.5rem;">
                                        <span>${escapeHtml(location)}</span>
                                        ${gpa ? `<span>GPA: ${escapeHtml(gpa)}</span>` : ''}
                                        <span>${escapeHtml(experience)}</span>
                                        ${degree ? `<span>${escapeHtml(degree)}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            console.log('Generated cardsHTML, length:', cardsHTML.length);
            console.log('First 500 chars of HTML:', cardsHTML.substring(0, 500));
            
            if (cardsHTML && cardsHTML.length > 0) {
                prospectsList.innerHTML = cardsHTML;
                console.log('Cards HTML inserted into DOM');
                console.log('prospectsList.innerHTML length after insertion:', prospectsList.innerHTML.length);
                
                // Verify cards are in DOM
                const renderedCards = prospectsList.querySelectorAll('.candidate-card');
                console.log('Number of .candidate-card elements found in DOM:', renderedCards.length);
                
                if (renderedCards.length === 0) {
                    console.error('Cards were inserted but not found in DOM!');
                    // Try a simple test
                    prospectsList.innerHTML = '<div class="candidate-card" style="padding: 2rem; background: red; color: white;"><h3>TEST CARD - If you see this, rendering works</h3><p>But candidate data might be missing</p></div>';
                } else {
                    // Check if cards have content
                    renderedCards.forEach((card, idx) => {
                        const nameEl = card.querySelector('.candidate-name');
                        console.log(`Card ${idx} - has name element:`, !!nameEl, nameEl ? nameEl.textContent : 'N/A');
                    });
                }
            } else {
                console.error('cardsHTML is empty!');
                prospectsList.innerHTML = '<div class="candidate-card" style="padding: 2rem; background: red; color: white;"><p>Error: No cards HTML generated. Candidates array might be empty or malformed.</p></div>';
            }
        }
        
        function toggleCandidateExpand(index) {
            console.log('=== toggleCandidateExpand called ===');
            console.log('index parameter:', index, 'type:', typeof index);
            console.log('Current expandedCandidateIndex:', expandedCandidateIndex);
            
            // Ensure index is a number
            const numIndex = typeof index === 'string' ? parseInt(index, 10) : index;
            if (isNaN(numIndex)) {
                console.error('Invalid index:', index);
                return;
            }
            
            // Toggle: if same index, collapse; otherwise expand new one
            if (expandedCandidateIndex === numIndex) {
                expandedCandidateIndex = null;
                console.log('Collapsing card at index:', numIndex);
            } else {
                expandedCandidateIndex = numIndex;
                console.log('Expanding card at index:', numIndex);
            }
            
            console.log('New expandedCandidateIndex:', expandedCandidateIndex);
            
            // Use the filtered candidates if available, otherwise use all candidates
            const candidatesToRender = window.filteredCandidatesData || window.allCandidatesData || [];
            console.log('Candidates to render:', candidatesToRender.length);
            
            if (candidatesToRender.length > 0) {
                console.log('Calling renderCandidateCards with expandedCandidateIndex:', expandedCandidateIndex);
                renderCandidateCards(candidatesToRender);
                console.log('renderCandidateCards completed');
            } else {
                console.error('No candidates data available to render!');
                console.error('window.filteredCandidatesData:', window.filteredCandidatesData);
                console.error('window.allCandidatesData:', window.allCandidatesData);
            }
        }
        
        function initializeFilters() {
            const thresholdSlider = document.getElementById('threshold-slider');
            const thresholdDisplay = document.getElementById('threshold-display');
            
            if (thresholdSlider) {
                thresholdSlider.addEventListener('input', (e) => {
                    currentThreshold = parseInt(e.target.value);
                    if (thresholdDisplay) thresholdDisplay.textContent = currentThreshold;
                    applyFilters();
                });
            }
            
            // Add event listeners for filter dropdowns
            const regionFilter = document.getElementById('region-filter');
            const experienceFilter = document.getElementById('experience-filter');
            const industryFilter = document.getElementById('industry-filter');
            
            if (regionFilter) {
                regionFilter.addEventListener('change', () => {
                    applyFilters();
                });
            }
            
            if (experienceFilter) {
                experienceFilter.addEventListener('change', () => {
                    applyFilters();
                });
            }
            
            if (industryFilter) {
                industryFilter.addEventListener('change', () => {
                    applyFilters();
                });
            }
            
            // Initialize campaign views
            const campaignBtns = document.querySelectorAll('.campaign-btn');
            campaignBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    campaignBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentView = btn.dataset.view;
                    updateCampaignView();
                });
            });
        }
        
        function applyFilters() {
            if (!window.allCandidatesData) return;
            
            const threshold = currentThreshold;
            const selectedRegion = document.getElementById('region-filter')?.value || 'all';
            const selectedExperience = document.getElementById('experience-filter')?.value || 'all';
            const selectedIndustry = document.getElementById('industry-filter')?.value || 'all';
            
            let filtered = window.allCandidatesData.filter(c => {
                // Filter by threshold
                const prob = c.probability ? parseFloat(c.probability) * 100 : 0;
                if (prob < threshold) return false;
                
                // Filter by region
                if (selectedRegion !== 'all') {
                    const background = c.background || c.rationale || c.whyMatch || '';
                    let location = c.location || extractLocation(background) || '';
                    location = getFullStateName(location);
                    if (location !== selectedRegion) return false;
                }
                
                // Filter by experience range
                if (selectedExperience !== 'all') {
                    const background = c.background || c.rationale || c.whyMatch || '';
                    const experienceText = extractExperience(background) || '';
                    const yearsMatch = experienceText.match(/(\d+)\s*years?/i);
                    const years = yearsMatch ? parseInt(yearsMatch[1]) : null;
                    
                    if (selectedExperience === 'no-exp') {
                        if (years !== null && years > 0) return false;
                    } else if (selectedExperience === '0-2') {
                        if (years === null || years < 0 || years > 2) return false;
                    } else if (selectedExperience === '2-5') {
                        if (years === null || years < 2 || years > 5) return false;
                    } else if (selectedExperience === '5-10') {
                        if (years === null || years < 5 || years > 10) return false;
                    } else if (selectedExperience === '10-15') {
                        if (years === null || years < 10 || years > 15) return false;
                    } else if (selectedExperience === '15+') {
                        if (years === null || years < 15) return false;
                    }
                }
                
                // Filter by industry
                if (selectedIndustry !== 'all') {
                    const background = (c.background || c.rationale || c.whyMatch || '').toLowerCase();
                    const interests = (c.interests || []).join(' ').toLowerCase();
                    const combinedText = background + ' ' + interests;
                    
                    let matches = false;
                    if (selectedIndustry === 'k12' && (combinedText.includes('k-12') || combinedText.includes('k12') || combinedText.includes('elementary') || combinedText.includes('secondary education'))) {
                        matches = true;
                    } else if (selectedIndustry === 'higher-ed' && (combinedText.includes('higher education') || combinedText.includes('university') || combinedText.includes('college'))) {
                        matches = true;
                    } else if (selectedIndustry === 'for-profit' && (combinedText.includes('for-profit') || combinedText.includes('for profit'))) {
                        matches = true;
                    } else if (selectedIndustry === 'non-profit' && (combinedText.includes('non-profit') || combinedText.includes('nonprofit') || combinedText.includes('ngo'))) {
                        matches = true;
                    } else if (selectedIndustry === 'edtech' && (combinedText.includes('edtech') || combinedText.includes('ed-tech') || combinedText.includes('technology'))) {
                        matches = true;
                    } else if (selectedIndustry === 'media' && (combinedText.includes('media') || combinedText.includes('publishing'))) {
                        matches = true;
                    } else if (selectedIndustry === 'corporate' && (combinedText.includes('corporate') || combinedText.includes('training'))) {
                        matches = true;
                    } else if (selectedIndustry === 'government' && (combinedText.includes('government') || combinedText.includes('public sector'))) {
                        matches = true;
                    } else if (selectedIndustry === 'healthcare' && (combinedText.includes('healthcare') || combinedText.includes('health care'))) {
                        matches = true;
                    } else if (selectedIndustry === 'consulting' && (combinedText.includes('consulting') || combinedText.includes('consultant'))) {
                        matches = true;
                    }
                    
                    if (!matches) return false;
                }
                
                return true;
            });
            
            // Sort by probability
            filtered.sort((a, b) => {
                const probA = a.probability ? parseFloat(a.probability) : 0;
                const probB = b.probability ? parseFloat(b.probability) : 0;
                return probB - probA;
            });
            
            // Update ranks
            filtered.forEach((candidate, index) => {
                candidate.rank = (index + 1).toString();
            });
            
            window.filteredCandidatesData = filtered;
            
            // Update KPIs based on filtered data and current threshold
            updateProspectingKPIs(filtered);
            
            renderCandidateCards(filtered);
            updateCampaignView();
        }
        
        // Update prospecting KPIs using current threshold
        function updateProspectingKPIs(filteredCandidates) {
            if (!window.allCandidatesData) return;
            
            const threshold = currentThreshold;
            
            // Total candidates reviewed from dataset (never changes)
            // Use the total processed count from backend if available, otherwise fall back to parsed candidates
            const totalReviewed = window.totalCandidatesProcessed || window.allCandidatesData.length;
            
            // General fit candidates: filtered by region/experience/industry only (not threshold)
            // This is the count of candidates that match the filters, regardless of threshold
            const selectedRegion = document.getElementById('region-filter')?.value || 'all';
            const selectedExperience = document.getElementById('experience-filter')?.value || 'all';
            const selectedIndustry = document.getElementById('industry-filter')?.value || 'all';
            
            const generalFit = window.allCandidatesData.filter(c => {
                // Filter by region
                if (selectedRegion !== 'all') {
                    const background = c.background || c.rationale || c.whyMatch || '';
                    let location = c.location || extractLocation(background) || '';
                    location = getFullStateName(location);
                    if (location !== selectedRegion) return false;
                }
                
                // Filter by experience range
                if (selectedExperience !== 'all') {
                    const background = c.background || c.rationale || c.whyMatch || '';
                    const experienceText = extractExperience(background) || '';
                    const yearsMatch = experienceText.match(/(\d+)\s*years?/i);
                    const years = yearsMatch ? parseInt(yearsMatch[1]) : null;
                    
                    if (selectedExperience === 'no-exp') {
                        if (years !== null && years > 0) return false;
                    } else if (selectedExperience === '0-2') {
                        if (years === null || years < 0 || years > 2) return false;
                    } else if (selectedExperience === '2-5') {
                        if (years === null || years < 2 || years > 5) return false;
                    } else if (selectedExperience === '5-10') {
                        if (years === null || years < 5 || years > 10) return false;
                    } else if (selectedExperience === '10-15') {
                        if (years === null || years < 10 || years > 15) return false;
                    } else if (selectedExperience === '15+') {
                        if (years === null || years < 15) return false;
                    }
                }
                
                // Filter by industry
                if (selectedIndustry !== 'all') {
                    const background = (c.background || c.rationale || c.whyMatch || '').toLowerCase();
                    const interests = (c.interests || []).join(' ').toLowerCase();
                    const combinedText = background + ' ' + interests;
                    
                    let matches = false;
                    if (selectedIndustry === 'k12' && (combinedText.includes('k-12') || combinedText.includes('k12') || combinedText.includes('elementary') || combinedText.includes('secondary education'))) {
                        matches = true;
                    } else if (selectedIndustry === 'higher-ed' && (combinedText.includes('higher education') || combinedText.includes('university') || combinedText.includes('college'))) {
                        matches = true;
                    } else if (selectedIndustry === 'for-profit' && (combinedText.includes('for-profit') || combinedText.includes('for profit'))) {
                        matches = true;
                    } else if (selectedIndustry === 'non-profit' && (combinedText.includes('non-profit') || combinedText.includes('nonprofit') || combinedText.includes('ngo'))) {
                        matches = true;
                    } else if (selectedIndustry === 'edtech' && (combinedText.includes('edtech') || combinedText.includes('ed-tech') || combinedText.includes('technology'))) {
                        matches = true;
                    } else if (selectedIndustry === 'media' && (combinedText.includes('media') || combinedText.includes('publishing'))) {
                        matches = true;
                    } else if (selectedIndustry === 'corporate' && (combinedText.includes('corporate') || combinedText.includes('training'))) {
                        matches = true;
                    } else if (selectedIndustry === 'government' && (combinedText.includes('government') || combinedText.includes('public sector'))) {
                        matches = true;
                    } else if (selectedIndustry === 'healthcare' && (combinedText.includes('healthcare') || combinedText.includes('health care'))) {
                        matches = true;
                    } else if (selectedIndustry === 'consulting' && (combinedText.includes('consulting') || combinedText.includes('consultant'))) {
                        matches = true;
                    }
                    
                    if (!matches) return false;
                }
                
                return true;
            }).length;
            
            // High probability candidates: from filtered list (by filters AND threshold) that meet threshold
            const highProbability = filteredCandidates ? filteredCandidates.filter(c => {
                const prob = c.probability ? parseFloat(c.probability) * 100 : 0;
                return prob >= threshold;
            }).length : 0;
            
            // Update threshold display in KPI label
            const thresholdDisplay = document.getElementById('prospecting-threshold-display');
            if (thresholdDisplay) thresholdDisplay.textContent = threshold;
            
            const totalEl = document.getElementById('prospecting-kpi-total');
            const fitEl = document.getElementById('prospecting-kpi-fit');
            const highEl = document.getElementById('prospecting-kpi-high');
            
            if (totalEl) totalEl.textContent = totalReviewed.toLocaleString();
            if (fitEl) fitEl.textContent = generalFit.toLocaleString();
            if (highEl) highEl.textContent = highProbability.toLocaleString();
            
            // Show export button
            const downloadBtn = document.getElementById('download-csv-btn');
            if (downloadBtn) downloadBtn.style.display = 'flex';
        }
        
        function showCandidateDetails(index) {
            console.log('=== showCandidateDetails called ===');
            console.log('Index:', index);
            console.log('window.filteredCandidatesData:', window.filteredCandidatesData);
            console.log('window.allCandidatesData:', window.allCandidatesData);
            
            const candidates = window.filteredCandidatesData || window.allCandidatesData || [];
            console.log('Candidates array length:', candidates.length);
            
            if (!candidates || candidates.length === 0) {
                console.error('No candidates data available!');
                return;
            }
            
            if (index < 0 || index >= candidates.length) {
                console.error('Invalid candidate index:', index, 'out of range [0,', candidates.length, ')');
                return;
            }
            
            const candidate = candidates[index];
            console.log('Selected candidate:', candidate);
            
            const viewport = document.getElementById('campaign-viewport');
            if (!viewport) {
                console.error('campaign-viewport element not found!');
                return;
            }
            
            console.log('Viewport found, updating content...');
            
            // Switch to list view to show candidate details
            currentView = 'list';
            const listBtn = document.querySelector('.campaign-btn.active');
            if (listBtn) listBtn.classList.remove('active');
            const newListBtn = document.querySelector('.campaign-btn[data-view="list"]');
            if (newListBtn) newListBtn.classList.add('active');
            
            // Extract candidate data
            const candidateName = candidate.name || candidate.fullName || candidate.candidateName || `Candidate ${index + 1}`;
            const candidateBackground = candidate.background || candidate.description || '';
            const contactInfo = extractContactInfo(candidate);
            
            // Build the detailed view
            let detailsHTML = `
                <div class="candidate-details-view">
                    <div class="candidate-details-header">
                        <h3 style="color: #6EE7D7; margin: 0 0 0.5rem 0; font-size: 1.25rem;">${escapeHtml(candidateName)}</h3>
                        <div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 1.5rem;">
                            <span class="propensity-badge" style="font-size: 1rem;">${candidate.probability ? (parseFloat(candidate.probability) > 1 ? parseFloat(candidate.probability).toFixed(1) : (parseFloat(candidate.probability) * 100).toFixed(1)) : '0'}% propensity</span>
                            ${candidate.rank ? `<span style="color: rgba(255, 255, 255, 0.7);">Rank: #${escapeHtml(candidate.rank)}</span>` : ''}
                        </div>
                    </div>
                    
                    ${candidateBackground ? `
                        <div class="candidate-detail-section">
                            <h4 style="color: #6EE7D7; font-size: 1rem; margin-bottom: 0.75rem; font-weight: 600;">ðŸ“‹ Background</h4>
                            <p style="color: rgba(255, 255, 255, 0.9); line-height: 1.6; margin: 0;">${escapeHtml(candidateBackground)}</p>
                        </div>
                    ` : ''}
                    
                    ${candidate.whyMatch ? `
                        <div class="candidate-detail-section">
                            <h4 style="color: #4CAF50; font-size: 1rem; margin-bottom: 0.75rem; font-weight: 600;">ðŸŽ¯ Why They Match</h4>
                            <p style="color: rgba(255, 255, 255, 0.9); line-height: 1.6; margin: 0;">${escapeHtml(candidate.whyMatch)}</p>
                        </div>
                    ` : ''}
                    
                    ${candidate.positiveDrivers && (Array.isArray(candidate.positiveDrivers) ? candidate.positiveDrivers.length > 0 : candidate.positiveDrivers) ? `
                        <div class="candidate-detail-section">
                            <h4 style="color: #4CAF50; font-size: 1rem; margin-bottom: 0.75rem; font-weight: 600;">âœ… Key Positive Drivers</h4>
                            ${Array.isArray(candidate.positiveDrivers) ? `
                                <ul style="margin: 0; padding-left: 1.5rem; color: rgba(255, 255, 255, 0.9); line-height: 1.8;">
                                    ${candidate.positiveDrivers.map(driver => `<li>${escapeHtml(driver)}</li>`).join('')}
                                </ul>
                            ` : `
                                <p style="color: rgba(255, 255, 255, 0.9); line-height: 1.6; margin: 0;">${escapeHtml(candidate.positiveDrivers)}</p>
                            `}
                        </div>
                    ` : ''}
                    
                    ${candidate.negativeDrivers && (Array.isArray(candidate.negativeDrivers) ? candidate.negativeDrivers.length > 0 : candidate.negativeDrivers) ? `
                        <div class="candidate-detail-section">
                            <h4 style="color: #f44336; font-size: 1rem; margin-bottom: 0.75rem; font-weight: 600;">âš ï¸ Key Negative Drivers</h4>
                            ${Array.isArray(candidate.negativeDrivers) ? `
                                <ul style="margin: 0; padding-left: 1.5rem; color: rgba(255, 255, 255, 0.9); line-height: 1.8;">
                                    ${candidate.negativeDrivers.map(driver => `<li>${escapeHtml(driver)}</li>`).join('')}
                                </ul>
                            ` : `
                                <p style="color: rgba(255, 255, 255, 0.9); line-height: 1.6; margin: 0;">${escapeHtml(candidate.negativeDrivers)}</p>
                            `}
                        </div>
                    ` : ''}
                    
                    ${candidate.strengths ? `
                        <div class="candidate-detail-section">
                            <h4 style="color: #5DADE2; font-size: 1rem; margin-bottom: 0.75rem; font-weight: 600;">ðŸ’ª Areas of Strength</h4>
                            <p style="color: rgba(255, 255, 255, 0.9); line-height: 1.6; margin: 0;">${escapeHtml(candidate.strengths)}</p>
                        </div>
                    ` : ''}
                    
                    ${candidate.assumptions ? `
                        <div class="candidate-detail-section">
                            <h4 style="color: #FFC300; font-size: 1rem; margin-bottom: 0.75rem; font-weight: 600;">âš ï¸ Assumptions/Warnings</h4>
                            <p style="color: rgba(255, 255, 255, 0.9); line-height: 1.6; margin: 0;">${escapeHtml(candidate.assumptions)}</p>
                        </div>
                    ` : ''}
                    
                    ${contactInfo ? `
                        <div class="candidate-detail-section">
                            <h4 style="color: #6EE7D7; font-size: 1rem; margin-bottom: 0.75rem; font-weight: 600;">ðŸ“§ Contact Information</h4>
                            <p style="color: #6EE7D7; line-height: 1.6; margin: 0;">${escapeHtml(contactInfo)}</p>
                        </div>
                    ` : ''}
                </div>
            `;
            
            console.log('Setting viewport innerHTML, length:', detailsHTML.length);
            
            // Store selected candidate index
            window.selectedCandidateIndex = index;
            
            viewport.innerHTML = detailsHTML;
            console.log('Viewport innerHTML set. Content length:', viewport.innerHTML.length);
            console.log('First 300 chars:', viewport.innerHTML.substring(0, 300));
            
            // Highlight the selected card
            const cards = document.querySelectorAll('.candidate-card');
            console.log('Found', cards.length, 'candidate cards');
            cards.forEach((card, idx) => {
                if (idx === index) {
                    card.style.borderColor = 'rgba(110, 231, 215, 0.8)';
                    card.style.boxShadow = '0 0 0 2px rgba(110, 231, 215, 0.3)';
                    console.log('Highlighted card at index', idx);
                } else {
                    card.style.borderColor = 'rgba(110, 231, 215, 0.3)';
                    card.style.boxShadow = 'none';
                }
            });
            
            console.log('showCandidateDetails completed');
        }
        
        function updateCampaignView() {
            const viewport = document.getElementById('campaign-viewport');
            if (!viewport || !window.filteredCandidatesData) return;
            
            if (currentView === 'list') {
                viewport.innerHTML = `
                    <p class="campaign-placeholder">
                        Click on a prospect card to view their detailed information here.
                    </p>
                `;
            } else if (currentView === 'email') {
                const emails = window.filteredCandidatesData.map(c => {
                    const contact = extractContactInfo(c);
                    const email = contact ? contact.split(',')[0].trim() : '';
                    return { name: c.name || 'Unknown', email };
                }).filter(c => c.email);
                
                viewport.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4 style="color: #6EE7D7; margin: 0;">Email Addresses</h4>
                        <button onclick="exportCampaignData('email')" style="background: transparent; border: none; color: #6EE7D7; cursor: pointer; padding: 0.25rem;">
                            <i data-lucide="download" style="width: 16px; height: 16px;"></i>
                        </button>
                    </div>
                    <div>
                        ${emails.length > 0 ? emails.map(c => `
                            <div class="campaign-contact-item">
                                <div class="campaign-contact-name">${escapeHtml(c.name)}</div>
                                <div class="campaign-contact-value">${escapeHtml(c.email)}</div>
                            </div>
                        `).join('') : '<p class="campaign-placeholder">No email addresses available</p>'}
                    </div>
                `;
            } else if (currentView === 'sms') {
                viewport.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4 style="color: #6EE7D7; margin: 0;">Phone Numbers</h4>
                        <button onclick="exportCampaignData('sms')" style="background: transparent; border: none; color: #6EE7D7; cursor: pointer; padding: 0.25rem;">
                            <i data-lucide="download" style="width: 16px; height: 16px;"></i>
                        </button>
                    </div>
                    <p class="campaign-placeholder">Phone number extraction not yet implemented</p>
                `;
            }
            
            // Re-initialize icons after updating content
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }
        
        // State abbreviation to full name mapping
        const stateNames = {
            'AL': 'Alabama', 'AK': 'Alaska', 'AZ': 'Arizona', 'AR': 'Arkansas', 'CA': 'California',
            'CO': 'Colorado', 'CT': 'Connecticut', 'DE': 'Delaware', 'FL': 'Florida', 'GA': 'Georgia',
            'HI': 'Hawaii', 'ID': 'Idaho', 'IL': 'Illinois', 'IN': 'Indiana', 'IA': 'Iowa',
            'KS': 'Kansas', 'KY': 'Kentucky', 'LA': 'Louisiana', 'ME': 'Maine', 'MD': 'Maryland',
            'MA': 'Massachusetts', 'MI': 'Michigan', 'MN': 'Minnesota', 'MS': 'Mississippi', 'MO': 'Missouri',
            'MT': 'Montana', 'NE': 'Nebraska', 'NV': 'Nevada', 'NH': 'New Hampshire', 'NJ': 'New Jersey',
            'NM': 'New Mexico', 'NY': 'New York', 'NC': 'North Carolina', 'ND': 'North Dakota', 'OH': 'Ohio',
            'OK': 'Oklahoma', 'OR': 'Oregon', 'PA': 'Pennsylvania', 'RI': 'Rhode Island', 'SC': 'South Carolina',
            'SD': 'South Dakota', 'TN': 'Tennessee', 'TX': 'Texas', 'UT': 'Utah', 'VT': 'Vermont',
            'VA': 'Virginia', 'WA': 'Washington', 'WV': 'West Virginia', 'WI': 'Wisconsin', 'WY': 'Wyoming',
            'DC': 'District of Columbia'
        };
        
        function getFullStateName(location) {
            if (!location) return location;
            const trimmed = location.trim().toUpperCase();
            // Check if it's a state abbreviation
            if (stateNames[trimmed]) {
                return stateNames[trimmed];
            }
            // Check if it contains a state abbreviation
            for (const [abbr, fullName] of Object.entries(stateNames)) {
                if (trimmed.includes(abbr)) {
                    return trimmed.replace(abbr, fullName);
                }
            }
            // If it's already a full name or something else, return as is
            return location;
        }
        
        function extractLocation(text) {
            const locationPatterns = /(?:from|located in|based in|resides in|in)\s+([A-Z][a-zA-Z\s,]+)/i;
            const match = text.match(locationPatterns);
            return match ? match[1].trim() : null;
        }
        
        function extractExperience(text) {
            if (!text) return null;
            const expPatterns = /(\d+)\s*(?:years?|yrs?)\s*(?:of\s*)?(?:experience|exp|work)/i;
            const match = text.match(expPatterns);
            return match ? `${match[1]} years exp` : null;
        }
        
        function extractGPA(text) {
            if (!text) return null;
            // Look for GPA patterns like "GPA: 3.8", "GPA 3.8", "3.8 GPA", "gpa_percentile: 85"
            const gpaPatterns = [
                /GPA[:\s]+(\d+\.\d+)/i,
                /(\d+\.\d+)\s+GPA/i,
                /gpa[:\s]+(\d+\.\d+)/i
            ];
            for (const pattern of gpaPatterns) {
                const match = text.match(pattern);
                if (match) {
                    return parseFloat(match[1]).toFixed(1);
                }
            }
            return null;
        }
        
        function extractDegree(text) {
            if (!text) return null;
            // Look for degree patterns like "Bachelor's Degree in X", "Bachelor of X", "Master's in X", etc.
            const degreePatterns = [
                /(?:Bachelor'?s?\s+(?:Degree\s+)?(?:in|of)\s+([A-Za-z\s]+))/i,
                /(?:Master'?s?\s+(?:Degree\s+)?(?:in|of)\s+([A-Za-z\s]+))/i,
                /(?:Doctoral?\s+(?:Degree\s+)?(?:in|of)\s+([A-Za-z\s]+))/i,
                /(?:PhD\s+(?:in|of)\s+([A-Za-z\s]+))/i
            ];
            for (const pattern of degreePatterns) {
                const match = text.match(pattern);
                if (match) {
                    const degreeType = text.match(/(Bachelor'?s?|Master'?s?|Doctoral?|PhD)/i);
                    const field = match[1].trim();
                    if (degreeType) {
                        return `${degreeType[0]} of ${field}`;
                    }
                    return field;
                }
            }
            // Try simpler pattern
            const simplePattern = /(Bachelor'?s?|Master'?s?|Doctoral?)\s+(?:Degree\s+)?(?:in|of)?\s*([A-Za-z\s]+)/i;
            const simpleMatch = text.match(simplePattern);
            if (simpleMatch) {
                return `${simpleMatch[1]} of ${simpleMatch[2].trim()}`;
            }
            return null;
        }
        
        function extractSkills(candidate) {
            const skills = [];
            const seen = new Set();
            const background = candidate.background || candidate.description || '';
            
            if (!background) {
                // Fallback to interests if no background
                if (candidate.interests && Array.isArray(candidate.interests)) {
                    return candidate.interests.slice(0, 3);
                }
                return skills;
            }
            
            // 1. Extract job titles/roles from the beginning of background (most common pattern)
            // Look for patterns like "School or District Leader", "Teacher", "Principal", etc.
            const jobTitlePatterns = [
                /^(School or District Leader|District Leader|School Leader)/i,
                /(School or District Leader|District Leader|School Leader|Principal|Vice Principal|Assistant Principal|Superintendent|Department Head|Program Manager|Curriculum Director|Education Director)/i,
                /(Teacher|Instructor|Professor|Lecturer|Educator|Coordinator|Specialist|Administrator|Manager|Director)/i
            ];
            
            for (const pattern of jobTitlePatterns) {
                const match = background.match(pattern);
                if (match && match[0]) {
                    let title = match[0].trim();
                    // Clean up common variations
                    if (title.toLowerCase().includes('school or district leader')) {
                        title = 'School Leader';
                    } else if (title.toLowerCase().includes('district leader') && !title.toLowerCase().includes('school')) {
                        title = 'District Leader';
                    } else if (title.toLowerCase().includes('school leader')) {
                        title = 'School Leader';
                    }
                    
                    if (!seen.has(title.toLowerCase()) && skills.length < 3) {
                        skills.push(title);
                        seen.add(title.toLowerCase());
                        break; // Take first match
                    }
                }
            }
            
            // 2. Extract education level/type (e.g., "Secondary Education", "Elementary Education")
            const educationLevelPatterns = [
                /(Secondary Education|Elementary Education|Primary Education|Higher Education|Early Childhood Education|Special Education|Adult Education)/i,
                /(K-12|Kâ€“12|K12)/i,
                /(secondary|elementary|primary|higher education)/i
            ];
            
            for (const pattern of educationLevelPatterns) {
                const match = background.match(pattern);
                if (match && match[0]) {
                    let level = match[0].trim();
                    // Normalize
                    if (level.match(/K-?12|Kâ€“?12/i)) {
                        level = 'K-12 Education';
                    } else if (level.toLowerCase().includes('secondary')) {
                        level = 'Secondary Education';
                    } else if (level.toLowerCase().includes('elementary')) {
                        level = 'Elementary Education';
                    } else if (level.toLowerCase().includes('primary')) {
                        level = 'Primary Education';
                    } else if (level.toLowerCase().includes('higher')) {
                        level = 'Higher Education';
                    }
                    
                    if (!seen.has(level.toLowerCase()) && skills.length < 3) {
                        skills.push(level);
                        seen.add(level.toLowerCase());
                        break; // Take first match
                    }
                }
            }
            
            // 3. Check interests array (from Figma pattern)
            if (candidate.interests && Array.isArray(candidate.interests) && skills.length < 3) {
                candidate.interests.forEach(interest => {
                    const clean = interest.trim();
                    if (clean && clean.length > 2 && !seen.has(clean.toLowerCase()) && skills.length < 3) {
                        skills.push(clean);
                        seen.add(clean.toLowerCase());
                    }
                });
            }
            
            // 4. Extract subject areas/fields from background if still need more
            if (skills.length < 3) {
                const subjectPatterns = [
                    /(Computer Science|Data Science|Machine Learning|AI Research|Business Analytics|Statistics|Mathematics|Engineering|Software Development)/i,
                    /(Social Sciences|Arts|Health|STEM|Science|Technology|Research|Policy|Curriculum Development)/i
                ];
                
                for (const pattern of subjectPatterns) {
                    const match = background.match(pattern);
                    if (match && match[0] && skills.length < 3) {
                        const subject = match[0].trim();
                        if (!seen.has(subject.toLowerCase())) {
                            skills.push(subject);
                            seen.add(subject.toLowerCase());
                        }
                    }
                }
            }
            
            // If no skills found, provide defaults based on background context
            if (skills.length === 0 && background) {
                // Try to infer from location/industry mentioned
                if (background.toLowerCase().includes('education') || background.toLowerCase().includes('school') || background.toLowerCase().includes('teacher')) {
                    skills.push('Education');
                }
                if (background.toLowerCase().includes('secondary') || background.toLowerCase().includes('high school')) {
                    skills.push('Secondary Education');
                } else if (background.toLowerCase().includes('elementary') || background.toLowerCase().includes('primary')) {
                    skills.push('Elementary Education');
                }
            }
            
            // Always return at least one skill if we have background
            if (skills.length === 0 && background) {
                skills.push('Education');
            }
            
            console.log('extractSkills returning:', skills);
            return skills.slice(0, 3); // Return max 3 skills
        }
        
        function exportCampaignData(type) {
            if (type === 'email' && window.filteredCandidatesData) {
                const emails = window.filteredCandidatesData.map(c => {
                    const contact = extractContactInfo(c);
                    return contact ? contact.split(',')[0].trim() : '';
                }).filter(e => e).join('\n');
                
                const blob = new Blob([emails], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'email_addresses.txt';
                a.click();
            }
        }
        
        // Make functions globally available
        window.toggleCandidateExpand = toggleCandidateExpand;
        window.showCandidateDetails = showCandidateDetails;
        window.exportCampaignData = exportCampaignData;

        function extractContactInfo(candidate) {
            // First check if email is directly stored
            if (candidate.email) {
                return candidate.email;
            }
            if (candidate.contactInfo) {
                return candidate.contactInfo;
            }
            // Try to extract email from background text
            if (candidate.background) {
                const emailMatch = candidate.background.match(/[\w\.-]+@[\w\.-]+\.\w+/);
                if (emailMatch) {
                    return emailMatch[0];
                }
            }
            return null;
        }

        function createCandidateModal(candidate, index) {
            const probability = candidate.probability !== null && candidate.probability !== undefined 
                ? (parseFloat(candidate.probability) * 100).toFixed(1) + '%'
                : 'N/A';
            const contactInfo = extractContactInfo(candidate);
            
            return `
                <div id="candidate-modal-${index}" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>ðŸ‘¤ ${escapeHtml(candidate.name || 'Unknown Candidate')}</h3>
                            <button class="close-modal" onclick="closeModal(${index})">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div style="margin-bottom: 2rem; display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; padding: 1.5rem; background: rgba(58, 134, 255, 0.1); border-radius: 8px; border-left: 4px solid #3A86FF;">
                                <div style="flex: 1; min-width: 200px;">
                                    <div style="font-size: 0.85rem; color: #5DADE2; margin-bottom: 0.5rem; font-weight: 600;">ðŸ“Š APPLICATION PROBABILITY</div>
                                    ${candidate.probability !== null && candidate.probability !== undefined ? 
                                        `<div class="score" style="font-size: 1.5rem; display: inline-block;">${probability}</div>` : 
                                        candidate.score ? `<div class="score" style="font-size: 1.5rem;">Score: ${escapeHtml(candidate.score)}</div>` : ''}
                                </div>
                                ${candidate.propensitySegment ? `
                                    <div style="flex: 1; min-width: 200px;">
                                        <div style="font-size: 0.85rem; color: #5DADE2; margin-bottom: 0.5rem; font-weight: 600;">ðŸŽ¯ PROPENSITY SEGMENT</div>
                                        <div class="propensity-segment ${candidate.propensitySegment.toLowerCase()}" style="font-size: 1.1rem; padding: 0.5rem 1rem;">${escapeHtml(candidate.propensitySegment.toUpperCase())}</div>
                                    </div>
                                ` : ''}
                                ${contactInfo ? `
                                    <div style="flex: 1; min-width: 200px;">
                                        <div style="font-size: 0.85rem; color: #5DADE2; margin-bottom: 0.5rem; font-weight: 600;">ðŸ“§ CONTACT</div>
                                        <div style="color: #5DADE2; font-size: 1rem;">${escapeHtml(contactInfo)}</div>
                                    </div>
                                ` : ''}
                            </div>
                            ${candidate.background ? `
                                <div class="section" style="margin-bottom: 1.5rem;">
                                    <div class="section-label" style="font-size: 1rem; margin-bottom: 0.5rem; color: #5DADE2;">ðŸ“ <strong>Background</strong></div>
                                    <div class="section-content" style="line-height: 1.6; font-size: 0.95rem;">${escapeHtml(candidate.background)}</div>
                                </div>
                            ` : ''}
                            ${candidate.positiveDrivers && candidate.positiveDrivers.length > 0 ? `
                                <div class="section" style="margin-bottom: 1.5rem;">
                                    <div class="section-label" style="font-size: 1rem; margin-bottom: 0.5rem; color: #4CAF50;">âœ… <strong>Key Positive Drivers</strong></div>
                                    <ul class="drivers-list positive" style="margin: 0; padding-left: 1.5rem;">
                                        ${candidate.positiveDrivers.map(driver => `<li style="margin-bottom: 0.5rem; color: #4CAF50; font-size: 0.95rem;">${escapeHtml(driver)}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            ${candidate.negativeDrivers && candidate.negativeDrivers.length > 0 ? `
                                <div class="section" style="margin-bottom: 1.5rem;">
                                    <div class="section-label" style="font-size: 1rem; margin-bottom: 0.5rem; color: #f44336;">âš ï¸ <strong>Key Negative Drivers</strong></div>
                                    <ul class="drivers-list negative" style="margin: 0; padding-left: 1.5rem;">
                                        ${candidate.negativeDrivers.map(driver => `<li style="margin-bottom: 0.5rem; color: #f44336; font-size: 0.95rem;">${escapeHtml(driver)}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            ${candidate.whyMatch ? `
                                <div class="section" style="margin-bottom: 1.5rem;">
                                    <div class="section-label" style="font-size: 1rem; margin-bottom: 0.5rem; color: #FFC300;">ðŸŽ¯ <strong>Why They Match</strong></div>
                                    <div class="section-content" style="line-height: 1.6; font-size: 0.95rem;">${escapeHtml(candidate.whyMatch)}</div>
                                </div>
                            ` : ''}
                            ${candidate.assumptions ? `
                                <div class="assumptions" style="margin-bottom: 1.5rem;">
                                    <div class="section-label" style="font-size: 1rem; margin-bottom: 0.5rem; color: #FFC300;">âš ï¸ <strong>Assumptions/Warnings</strong></div>
                                    <div class="section-content" style="line-height: 1.6; font-size: 0.95rem;">${escapeHtml(candidate.assumptions)}</div>
                                </div>
                            ` : ''}
                            ${candidate.strengths ? `
                                <div class="section" style="margin-bottom: 1.5rem;">
                                    <div class="section-label" style="font-size: 1rem; margin-bottom: 0.5rem; color: #5DADE2;">ðŸ’ª <strong>Areas of Strength</strong></div>
                                    <div class="section-content" style="line-height: 1.6; font-size: 0.95rem;">${escapeHtml(candidate.strengths)}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // Old modal showCandidateDetails removed - using sidebar view instead

        function closeModal(index) {
            const modal = document.getElementById(`candidate-modal-${index}`);
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        });

        function parseCandidates(text) {
            const candidates = [];
            
            // Try to extract structured candidates from the text
            // Look for patterns like "1. Name" followed by probability, background, etc.
            const lines = text.split('\n');
            let currentCandidate = null;
            let currentSection = null;
            
            for (let i = 0; i < lines.length; i++) {
                let line = lines[i].trim();
                if (!line) continue;
                
                // Skip markdown code blocks
                if (line.startsWith('```')) continue;
                
                // Check if this is a candidate number (e.g., "1.", "2.", etc.)
                // Handle formats like: "1. [Full Name: first_name + last_name]" or "1. John Doe"
                const candidateMatch = line.match(/^(\d+)\.\s*(.+)$/);
                if (candidateMatch) {
                    if (currentCandidate) {
                        candidates.push(currentCandidate);
                    }
                    // Clean markdown formatting from name
                    let name = candidateMatch[2].replace(/\*\*/g, '').trim();
                    
                    // Handle "[Full Name: first_name + last_name]" format
                    const fullNameMatch = name.match(/\[Full Name:\s*(.+?)\]/i);
                    if (fullNameMatch) {
                        name = fullNameMatch[1].trim();
                        // Handle "first_name + last_name" format
                        name = name.replace(/\s*\+\s*/g, ' ').trim();
                    } else {
                        // Remove brackets if present
                        name = name.replace(/\[|\]/g, '').trim();
                        // Remove "Full Name:" prefix if present
                        name = name.replace(/^full name:\s*/i, '').trim();
                    }
                    
                    currentCandidate = {
                        rank: candidateMatch[1],
                        name: name,
                        score: null,
                        probability: null,
                        propensitySegment: null,
                        background: '',
                        whyMatch: '',
                        strengths: '',
                        positiveDrivers: [],
                        negativeDrivers: [],
                        assumptions: '',
                        email: null,
                        contactInfo: null,
                        interests: []
                    };
                    currentSection = null;
                    continue;
                }
                
                if (!currentCandidate) continue;
                
                // Check for Predicted Application Probability or Application Probability
                // Look for lines like "Predicted Application Probability: 0.75" or "Application Probability: 0.82"
                if (line.toLowerCase().includes('predicted application probability') || 
                    line.toLowerCase().includes('application probability')) {
                    // Try patterns: "Predicted Application Probability: 0.85", "Application Probability: 0.75", etc.
                    const probMatch = line.match(/probability[:\s]+([0-9.]+)/i);
                    if (probMatch) {
                        const probValue = parseFloat(probMatch[1]);
                        // If value is > 1, assume it's a percentage and convert
                        // Otherwise use as decimal (0.0-1.0)
                        currentCandidate.probability = probValue > 1 ? probValue / 100 : probValue;
                    } else if (line.toLowerCase().includes('null')) {
                        // Only set to null if explicitly stated
                        currentCandidate.probability = null;
                    }
                    continue;
                }
                
                // Also check for just "Probability:" on a line
                if (line.toLowerCase().startsWith('probability:') || line.toLowerCase().startsWith('probability ')) {
                    const probMatch = line.match(/probability[:\s]+([0-9.]+)/i);
                    if (probMatch) {
                        const probValue = parseFloat(probMatch[1]);
                        currentCandidate.probability = probValue > 1 ? probValue / 100 : probValue;
                    }
                    continue;
                }
                
                // Check for Score in various formats (fallback)
                if (line.toLowerCase().includes('score:')) {
                    // Try different patterns: "Score: 95/100", "Score: 95", "Score: 85/100 -", etc.
                    const scoreMatch = line.match(/score:\s*(\d+)(?:\/(\d+))?/i);
                    if (scoreMatch) {
                        const score = scoreMatch[1];
                        const max = scoreMatch[2] || '100';
                        currentCandidate.score = `${score}/${max}`;
                    }
                    continue;
                }
                
                // Check for Propensity Segment
                if (line.toLowerCase().includes('propensity segment') || 
                    (line.toLowerCase().includes('propensity') && line.match(/propensity[:\s]+(high|medium|low)/i))) {
                    const segmentMatch = line.match(/propensity[:\s]+(high|medium|low)/i);
                    if (segmentMatch) {
                        currentCandidate.propensitySegment = segmentMatch[1].toLowerCase();
                    }
                    continue;
                }
                
                // Check for Contact/Email - be more flexible with format
                // Check for Location
                if (line.toLowerCase().includes('location:')) {
                    const locationMatch = line.match(/location:\s*(.+)/i);
                    if (locationMatch) {
                        currentCandidate.location = locationMatch[1].trim();
                    }
                    continue;
                }
                
                // Check for Skills/Tags
                if (line.toLowerCase().includes('skills/tags:') || line.toLowerCase().includes('skills:') || line.toLowerCase().includes('tags:')) {
                    const skillsMatch = line.match(/(?:skills\/tags|skills|tags):\s*(.+)/i);
                    if (skillsMatch) {
                        const skillsStr = skillsMatch[1].trim();
                        // Split by comma and clean up
                        currentCandidate.skills = skillsStr.split(',').map(s => s.trim()).filter(s => s.length > 0);
                        currentCandidate.interests = currentCandidate.skills; // Also set interests for compatibility
                    }
                    continue;
                }
                
                if (line.toLowerCase().includes('contact:') || line.toLowerCase().includes('email:')) {
                    const contactMatch = line.match(/(?:contact|email):\s*(.+)/i);
                    if (contactMatch) {
                        const contactValue = contactMatch[1].trim();
                        // Check if it's an email
                        const emailMatch = contactValue.match(/[\w\.-]+@[\w\.-]+\.\w+/);
                        if (emailMatch) {
                            currentCandidate.email = emailMatch[0];
                            currentCandidate.contactInfo = emailMatch[0];
                        } else {
                            currentCandidate.contactInfo = contactValue;
                        }
                    }
                    continue;
                }
                
                // Also check for email pattern anywhere in the line
                if (!currentCandidate.email) {
                    const emailMatch = line.match(/[\w\.-]+@[\w\.-]+\.\w+/);
                    if (emailMatch && line.toLowerCase().includes('contact')) {
                        currentCandidate.email = emailMatch[0];
                        currentCandidate.contactInfo = emailMatch[0];
                    }
                }
                
                // Check for section labels
                const sectionLabels = {
                    'background:': 'background',
                    'background': 'background',
                    'why they match:': 'whyMatch',
                    'why they match': 'whyMatch',
                    'key positive drivers:': 'positiveDrivers',
                    'key positive drivers': 'positiveDrivers',
                    'positive drivers:': 'positiveDrivers',
                    'positive drivers': 'positiveDrivers',
                    'key negative drivers:': 'negativeDrivers',
                    'key negative drivers': 'negativeDrivers',
                    'negative drivers:': 'negativeDrivers',
                    'negative drivers': 'negativeDrivers',
                    'assumptions/warnings:': 'assumptions',
                    'assumptions/warnings': 'assumptions',
                    'assumptions or warnings:': 'assumptions',
                    'assumptions or warnings': 'assumptions',
                    'assumptions:': 'assumptions',
                    'warnings:': 'assumptions',
                    'areas of strength:': 'strengths',
                    'areas of strength': 'strengths',
                    'areas of concern:': 'concerns'
                };
                
                let foundSection = false;
                const lowerLine = line.toLowerCase();
                for (const [label, key] of Object.entries(sectionLabels)) {
                    if (lowerLine.startsWith(label.toLowerCase())) {
                        currentSection = key;
                        let content = line.substring(label.length).trim();
                        // Clean markdown formatting
                        content = content.replace(/\*\*/g, '').replace(/\[|\]/g, '').trim();
                        if (content) {
                            if (key === 'positiveDrivers' || key === 'negativeDrivers') {
                                // Initialize array if needed
                                if (!currentCandidate[key]) {
                                    currentCandidate[key] = [];
                                }
                                // If there's content on the same line, add it
                                if (content) {
                                    currentCandidate[key].push(content);
                                }
                            } else {
                                currentCandidate[key] = content;
                            }
                        }
                        foundSection = true;
                        break;
                    }
                }
                
                // If not a section label, append to current section
                if (!foundSection && currentSection) {
                    // Clean markdown and append
                    const cleanedLine = line.replace(/\*\*/g, '').replace(/\[|\]/g, '').trim();
                    
                    // Handle list items for drivers
                    if (currentSection === 'positiveDrivers' || currentSection === 'negativeDrivers') {
                        // Initialize array if needed
                        if (!currentCandidate[currentSection]) {
                            currentCandidate[currentSection] = [];
                        }
                        // Check if line starts with bullet, dash, number, or is indented
                        if (cleanedLine && (cleanedLine.match(/^[-â€¢\d.)]\s+/) || line.startsWith('   ') || line.startsWith('\t'))) {
                            const listItemMatch = cleanedLine.match(/^[-â€¢\d.)]\s*(.+)$/);
                            if (listItemMatch) {
                                currentCandidate[currentSection].push(listItemMatch[1]);
                            } else {
                                currentCandidate[currentSection].push(cleanedLine);
                            }
                        } else if (cleanedLine && currentCandidate[currentSection].length > 0) {
                            // Continue previous item
                            const lastIndex = currentCandidate[currentSection].length - 1;
                            currentCandidate[currentSection][lastIndex] += ' ' + cleanedLine;
                        } else if (cleanedLine) {
                            currentCandidate[currentSection].push(cleanedLine);
                        }
                    } else if (currentSection === 'interests') {
                        // Handle interests as array
                        if (!currentCandidate.interests) {
                            currentCandidate.interests = [];
                        }
                        // Split by comma or semicolon, or add as single item
                        const interestItems = cleanedLine.split(/[,;]/).map(i => i.trim()).filter(i => i);
                        currentCandidate.interests.push(...interestItems);
                    } else {
                        // For other sections, append as before
                        if (typeof currentCandidate[currentSection] === 'string') {
                            currentCandidate[currentSection] += (currentCandidate[currentSection] ? ' ' : '') + cleanedLine;
                        } else if (!currentCandidate[currentSection]) {
                            currentCandidate[currentSection] = cleanedLine;
                        }
                    }
                } else if (!foundSection && !currentSection) {
                    // If no current section but line has content, it might be background or continuation
                    // Check if it looks like background info (contains work exp, years, etc.)
                    const cleanedLine = line.replace(/\*\*/g, '').replace(/\[|\]/g, '').trim();
                    if (cleanedLine && (cleanedLine.toLowerCase().includes('years') || 
                        cleanedLine.toLowerCase().includes('experience') || 
                        cleanedLine.toLowerCase().includes('position') ||
                        cleanedLine.toLowerCase().includes('degree'))) {
                        if (!currentCandidate.background) {
                            currentCandidate.background = cleanedLine;
                        } else {
                            currentCandidate.background += ' ' + cleanedLine;
                        }
                    }
                }
                
                // Try to extract email from any line for contact info
                if (currentCandidate && !currentCandidate.email) {
                    const emailMatch = line.match(/[\w\.-]+@[\w\.-]+\.\w+/);
                    if (emailMatch) {
                        currentCandidate.email = emailMatch[0];
                        currentCandidate.contactInfo = emailMatch[0];
                    }
                }
            }
            
            // Add the last candidate
            if (currentCandidate) {
                candidates.push(currentCandidate);
            }
            
            console.log('parseCandidates found', candidates.length, 'candidates');
            if (candidates.length > 0) {
                console.log('First candidate parsed:', JSON.stringify(candidates[0], null, 2));
            }
            
            // Post-process: extract emails from background if not already found
            candidates.forEach(candidate => {
                if (!candidate.email && candidate.background) {
                    const emailMatch = candidate.background.match(/[\w\.-]+@[\w\.-]+\.\w+/);
                    if (emailMatch) {
                        candidate.email = emailMatch[0];
                        candidate.contactInfo = emailMatch[0];
                    }
                }
            });
            
            return candidates;
        }

        function showError(message) {
            document.getElementById('error-container').innerHTML = 
                `<div class="error-message">${escapeHtml(message)}</div>`;
            document.querySelector('.demo-form-section').style.display = 'block';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function downloadCSV() {
            if (!window.candidatesData || window.candidatesData.length === 0) {
                alert('No candidates data available to download.');
                return;
            }

            const candidates = window.candidatesData;
            
            // Define CSV headers
            const headers = [
                'Position',
                'Full Name',
                'Application Probability (%)',
                'Propensity Segment',
                'Contact Information',
                'Background',
                'Positive Drivers',
                'Negative Drivers',
                'Assumptions/Warnings'
            ];

            // Convert candidates to CSV rows
            const rows = candidates.map(candidate => {
                const probability = candidate.probability !== null && candidate.probability !== undefined 
                    ? (parseFloat(candidate.probability) * 100).toFixed(1)
                    : 'N/A';
                
                const contactInfo = extractContactInfo(candidate) || 'Not available';
                
                const positiveDrivers = Array.isArray(candidate.positiveDrivers) 
                    ? candidate.positiveDrivers.join('; ')
                    : (candidate.positiveDrivers || '');
                
                const negativeDrivers = Array.isArray(candidate.negativeDrivers) 
                    ? candidate.negativeDrivers.join('; ')
                    : (candidate.negativeDrivers || '');
                
                // Escape CSV values (handle commas, quotes, newlines)
                const escapeCSV = (value) => {
                    if (value === null || value === undefined) return '';
                    const str = String(value);
                    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                        return '"' + str.replace(/"/g, '""') + '"';
                    }
                    return str;
                };

                return [
                    escapeCSV(candidate.rank || ''),
                    escapeCSV(candidate.name || 'Unknown'),
                    escapeCSV(probability),
                    escapeCSV(candidate.propensitySegment || ''),
                    escapeCSV(contactInfo),
                    escapeCSV(candidate.background || ''),
                    escapeCSV(positiveDrivers),
                    escapeCSV(negativeDrivers),
                    escapeCSV(candidate.assumptions || '')
                ].join(',');
            });

            // Combine headers and rows
            const csvContent = [headers.join(','), ...rows].join('\n');

            // Create blob and download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `udiscovery_candidates_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Restore saved data on page load
        function restoreSavedData() {
            const savedFormData = localStorage.getItem('udiscovery_formData');
            const savedResults = localStorage.getItem('udiscovery_results');
            const savedAdmissionResults = localStorage.getItem('udiscovery_admission_results');
            
            if (savedFormData) {
                try {
                    const formData = JSON.parse(savedFormData);
                    // Restore form fields
                    document.getElementById('university-name').value = formData.universityName || '';
                    document.getElementById('program-name').value = formData.programName || '';
                    document.getElementById('program-level').value = formData.programLevel || '';
                    document.getElementById('program-goals').value = formData.programGoals || '';
                    document.getElementById('program-focus').value = formData.programFocus || '';
                    document.getElementById('program-location').value = formData.programLocation || '';
                    document.getElementById('additional-requirements').value = formData.additionalRequirements || '';
                } catch (e) {
                    console.error('Error restoring form data:', e);
                }
            }
            
            // Check for admission results first (if user was on admissions page)
            if (savedAdmissionResults) {
                // Hide form, show admission results
                document.querySelector('.demo-form-section').style.display = 'none';
                document.getElementById('results-section').style.display = 'none';
                document.getElementById('admission-results-section').style.display = 'block';
                
                // Display the saved admission results
                displayAdmissionResults(savedAdmissionResults);
                
                // Update navigation to highlight Admissions
                const navProspecting = document.getElementById('nav-prospecting');
                const navAdmissions = document.getElementById('nav-admissions');
                if (navProspecting) navProspecting.style.color = 'rgba(148, 163, 184, 1)';
                if (navAdmissions) navAdmissions.style.color = '#4B9BFF';
                
                // Show a message that results were restored
                const timestamp = localStorage.getItem('udiscovery_admission_timestamp');
                if (timestamp) {
                    const date = new Date(timestamp);
                    const timeStr = date.toLocaleString();
                    const restoreMsg = document.createElement('div');
                    restoreMsg.className = 'restore-message';
                    restoreMsg.style.cssText = 'background: rgba(255, 195, 0, 0.2); border-left: 4px solid #FFC300; padding: 1rem; margin-bottom: 1rem; border-radius: 6px; color: #E8EDF3; margin-left: 10rem; margin-right: 10rem;';
                    restoreMsg.innerHTML = `ðŸ“‹ <strong>Restored previous admission session</strong> - Results from ${timeStr}. <button onclick="clearAdmissionData()" style="background: #FFC300; color: #212F45; border: none; padding: 0.25rem 0.75rem; border-radius: 4px; cursor: pointer; font-weight: 600; margin-left: 0.5rem;">Clear & Start New</button>`;
                    const admissionHeader = document.querySelector('#admission-results-section > div:first-child');
                    if (admissionHeader) {
                        admissionHeader.insertBefore(restoreMsg, admissionHeader.firstChild);
                    }
                }
            }
            // If we have saved prospection results, show them
            else if (savedResults) {
                // Hide form, show results
                document.querySelector('.demo-form-section').style.display = 'none';
                document.getElementById('results-section').style.display = 'block';
                document.getElementById('admission-results-section').style.display = 'none';
                
                // Display the saved results
                displayResults(savedResults);
                
                // Update navigation to highlight Prospecting
                const navProspecting = document.getElementById('nav-prospecting');
                const navAdmissions = document.getElementById('nav-admissions');
                if (navProspecting) navProspecting.style.color = '#6EE7D7';
                if (navAdmissions) navAdmissions.style.color = 'rgba(148, 163, 184, 1)';
                
                // Show a message that results were restored
                const timestamp = localStorage.getItem('udiscovery_timestamp');
                if (timestamp) {
                    const date = new Date(timestamp);
                    const timeStr = date.toLocaleString();
                    const restoreMsg = document.createElement('div');
                    restoreMsg.className = 'restore-message';
                    restoreMsg.style.cssText = 'background: rgba(255, 195, 0, 0.2); border-left: 4px solid #FFC300; padding: 1rem; margin-bottom: 1rem; border-radius: 6px; color: #E8EDF3;';
                    restoreMsg.innerHTML = `ðŸ“‹ <strong>Restored previous session</strong> - Results from ${timeStr}. <button onclick="clearSavedData()" style="background: #FFC300; color: #212F45; border: none; padding: 0.25rem 0.75rem; border-radius: 4px; cursor: pointer; font-weight: 600; margin-left: 0.5rem;">Clear & Start New</button>`;
                    const resultsHeader = document.querySelector('.results-header');
                    if (resultsHeader) {
                        resultsHeader.insertBefore(restoreMsg, resultsHeader.firstChild);
                    }
                }
            }
        }
        
        // Clear saved data
        function clearSavedData() {
            localStorage.removeItem('udiscovery_formData');
            localStorage.removeItem('udiscovery_results');
            localStorage.removeItem('udiscovery_timestamp');
            location.reload();
        }
        
        // Clear admission data
        function clearAdmissionData() {
            localStorage.removeItem('udiscovery_admission_results');
            localStorage.removeItem('udiscovery_admission_timestamp');
            location.reload();
        }
        
        // Make clear functions available globally
        window.clearSavedData = clearSavedData;
        window.clearAdmissionData = clearAdmissionData;
        
        // Restore on page load
        // Update welcome message on page load
        function updateWelcomeMessage() {
            const savedFormData = localStorage.getItem('udiscovery_formData');
            if (savedFormData) {
                try {
                    const formData = JSON.parse(savedFormData);
                    const welcomeMsg = document.getElementById('welcome-message');
                    if (welcomeMsg && formData.universityName) {
                        welcomeMsg.textContent = `Welcome, ${formData.universityName}!`;
                    }
                } catch (e) {
                    console.error('Error parsing form data:', e);
                }
            }
        }
        
        // Navigation handlers
        function setupNavigation() {
            const navProspecting = document.getElementById('nav-prospecting');
            const navAdmissions = document.getElementById('nav-admissions');
            
            if (navProspecting) {
                navProspecting.addEventListener('click', function(e) {
                    e.preventDefault();
                    // Show prospecting results if available, otherwise show form
                    const resultsSection = document.getElementById('results-section');
                    const formSection = document.querySelector('.demo-form-section');
                    const admissionsSection = document.getElementById('admissions-section');
                    
                    if (resultsSection && resultsSection.style.display !== 'none') {
                        // Already showing prospecting results
                        return;
                    }
                    
                    // Hide admissions, show prospecting
                    if (admissionsSection) admissionsSection.classList.remove('active');
                    if (formSection) formSection.style.display = 'block';
                    if (resultsSection) resultsSection.style.display = 'none';
                    
                    // Update nav colors
                    navProspecting.style.color = '#6EE7D7';
                    navAdmissions.style.color = 'rgba(148, 163, 184, 1)';
                });
            }
            
            if (navAdmissions) {
                navAdmissions.addEventListener('click', function(e) {
                    e.preventDefault();
                    // Trigger admission assessment
                    runAdmissionAssessment();
                    
                    // Update nav colors
                    navProspecting.style.color = 'rgba(148, 163, 184, 1)';
                    navAdmissions.style.color = '#4B9BFF';
                });
            }
        }
        
        // Store admission data globally
        window.allAdmissionData = [];
        window.filteredAdmissionData = [];
        let currentAdmissionThreshold = 75;
        let selectedAdmissionApplicant = null;
        
        // Display admission results
        function displayAdmissionResults(resultJson) {
            try {
                const result = typeof resultJson === 'string' ? JSON.parse(resultJson) : resultJson;
                console.log('Admission result type:', typeof result);
                console.log('Admission result:', result);
                
                if (!result || !result.results || !Array.isArray(result.results)) {
                    throw new Error('Invalid admission result format');
                }
                
                const applicants = result.results.filter(a => !a.error);
                
                // Sort by probability of success (descending - highest first)
                applicants.sort((a, b) => {
                    const probA = a.probability_of_success ? (a.probability_of_success > 1 ? a.probability_of_success : a.probability_of_success * 100) : 0;
                    const probB = b.probability_of_success ? (b.probability_of_success > 1 ? b.probability_of_success : b.probability_of_success * 100) : 0;
                    return probB - probA; // Descending order
                });
                
                // Store globally
                window.allAdmissionData = applicants;
                window.filteredAdmissionData = applicants;
                
                // Update KPIs (use all data, not filtered)
                updateAdmissionKPIs(window.allAdmissionData);
                
                // Initialize filters
                initializeAdmissionFilters();
                
                // Render applicant cards
                renderAdmissionCards(applicants);
                
                // Show results section
                document.getElementById('admission-results-section').style.display = 'block';
                document.getElementById('results-section').style.display = 'none';
                
                // Re-initialize icons
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
                
            } catch (error) {
                console.error('Error displaying admission results:', error);
                showError(`Failed to display admission results: ${error.message}`);
            }
        }
        
        // Calculate decision from probability using current threshold
        function calculateDecisionFromProbability(probability, threshold = null) {
            // Use current threshold if not provided
            const admitThreshold = threshold !== null ? threshold / 100 : currentAdmissionThreshold / 100;
            const waitlistThreshold = admitThreshold - 0.05; // 5% less than ADMIT threshold
            
            // Convert to 0-1 scale if it's 0-100
            const prob = probability > 1 ? probability / 100 : probability;
            
            // ADMIT: >= threshold
            // WAITLIST: >= (threshold - 5%) but < threshold
            // REJECTED: anything below (threshold - 5%)
            if (prob >= admitThreshold) return 'ADMIT';
            if (prob >= waitlistThreshold) return 'WAITLIST';
            return 'NOT_ADMITTED';
        }
        
        // Calculate risk band from probability using current threshold
        function calculateRiskBand(probability, threshold = null) {
            // Use current threshold if not provided
            const admitThreshold = threshold !== null ? threshold / 100 : currentAdmissionThreshold / 100;
            const waitlistThreshold = admitThreshold - 0.05; // 5% less than ADMIT threshold
            
            // Convert to 0-1 scale if it's 0-100
            const prob = probability > 1 ? probability / 100 : probability;
            
            // Align risk bands with decision thresholds
            if (prob >= admitThreshold) return 'Low Risk';
            if (prob >= waitlistThreshold) return 'Medium Risk';
            return 'High Risk';
        }
        
        // Update admission KPIs using current threshold
        function updateAdmissionKPIs(applicants) {
            const total = applicants.length;
            const admitThreshold = currentAdmissionThreshold / 100;
            const waitlistThreshold = admitThreshold - 0.05; // 5% less than ADMIT threshold
            
            // Calculate decisions from probability using current threshold
            const accepted = applicants.filter(a => {
                const prob = a.probability_of_success > 1 ? a.probability_of_success / 100 : a.probability_of_success;
                return prob >= admitThreshold;
            }).length;
            const waitlisted = applicants.filter(a => {
                const prob = a.probability_of_success > 1 ? a.probability_of_success / 100 : a.probability_of_success;
                return prob >= waitlistThreshold && prob < admitThreshold;
            }).length;
            const rejected = applicants.filter(a => {
                const prob = a.probability_of_success > 1 ? a.probability_of_success / 100 : a.probability_of_success;
                return prob < waitlistThreshold;
            }).length;
            
            document.getElementById('admission-kpi-total').textContent = total;
            document.getElementById('admission-kpi-accepted').textContent = accepted;
            document.getElementById('admission-kpi-waitlisted').textContent = waitlisted;
            document.getElementById('admission-kpi-rejected').textContent = rejected;
            
            // Show export button
            document.getElementById('download-admission-csv-btn').style.display = 'flex';
        }
        
        // Initialize admission filters
        function initializeAdmissionFilters() {
            const thresholdSlider = document.getElementById('admission-threshold-slider');
            const thresholdDisplay = document.getElementById('admission-threshold-display');
            const regionFilter = document.getElementById('admission-region-filter');
            const experienceFilter = document.getElementById('admission-experience-filter');
            const industryFilter = document.getElementById('admission-industry-filter');
            
            if (thresholdSlider) {
                thresholdSlider.addEventListener('input', (e) => {
                    currentAdmissionThreshold = parseInt(e.target.value);
                    if (thresholdDisplay) thresholdDisplay.textContent = currentAdmissionThreshold;
                    applyAdmissionFilters();
                });
            }
            
            if (regionFilter) {
                regionFilter.addEventListener('change', () => applyAdmissionFilters());
            }
            
            if (experienceFilter) {
                experienceFilter.addEventListener('change', () => applyAdmissionFilters());
            }
            
            if (industryFilter) {
                industryFilter.addEventListener('change', () => applyAdmissionFilters());
            }
        }
        
        // Apply admission filters
        function applyAdmissionFilters() {
            if (!window.allAdmissionData) return;
            
            const selectedRegion = document.getElementById('admission-region-filter')?.value || 'all';
            const selectedExperience = document.getElementById('admission-experience-filter')?.value || 'all';
            const selectedIndustry = document.getElementById('admission-industry-filter')?.value || 'all';
            
            // Filter by region, experience, and industry (but NOT by threshold - show all candidates)
            let filtered = window.allAdmissionData.filter(a => {
                // Filter by region
                if (selectedRegion !== 'all') {
                    const location = a.location || '';
                    if (location !== selectedRegion) return false;
                }
                
                // Filter by experience range
                if (selectedExperience !== 'all') {
                    const teachingExp = a.teaching_experience_years || 0;
                    const years = typeof teachingExp === 'number' ? teachingExp : parseFloat(teachingExp) || 0;
                    
                    if (selectedExperience === 'no-exp') {
                        if (years > 0) return false;
                    } else if (selectedExperience === '0-2') {
                        if (years < 0 || years > 2) return false;
                    } else if (selectedExperience === '2-5') {
                        if (years < 2 || years > 5) return false;
                    } else if (selectedExperience === '5-10') {
                        if (years < 5 || years > 10) return false;
                    } else if (selectedExperience === '10-15') {
                        if (years < 10 || years > 15) return false;
                    } else if (selectedExperience === '15+') {
                        if (years < 15) return false;
                    }
                }
                
                // Filter by industry - check CV, roles, and other fields
                if (selectedIndustry !== 'all') {
                    // Get applicant data fields that might contain industry info
                    const cv = (a.cv || '').toLowerCase();
                    const roles = (a.roles_in_education || '').toLowerCase();
                    const fieldOfStudy = (a.field_of_study || '').toLowerCase();
                    const combinedText = cv + ' ' + roles + ' ' + fieldOfStudy;
                    
                    let matches = false;
                    if (selectedIndustry === 'k12' && (combinedText.includes('k-12') || combinedText.includes('k12') || combinedText.includes('elementary') || combinedText.includes('secondary education'))) {
                        matches = true;
                    } else if (selectedIndustry === 'higher-ed' && (combinedText.includes('higher education') || combinedText.includes('university') || combinedText.includes('college'))) {
                        matches = true;
                    } else if (selectedIndustry === 'for-profit' && (combinedText.includes('for-profit') || combinedText.includes('for profit'))) {
                        matches = true;
                    } else if (selectedIndustry === 'non-profit' && (combinedText.includes('non-profit') || combinedText.includes('nonprofit') || combinedText.includes('ngo'))) {
                        matches = true;
                    } else if (selectedIndustry === 'edtech' && (combinedText.includes('edtech') || combinedText.includes('ed-tech') || combinedText.includes('technology'))) {
                        matches = true;
                    } else if (selectedIndustry === 'media' && (combinedText.includes('media') || combinedText.includes('publishing'))) {
                        matches = true;
                    } else if (selectedIndustry === 'corporate' && (combinedText.includes('corporate') || combinedText.includes('training'))) {
                        matches = true;
                    } else if (selectedIndustry === 'government' && (combinedText.includes('government') || combinedText.includes('public sector'))) {
                        matches = true;
                    } else if (selectedIndustry === 'healthcare' && (combinedText.includes('healthcare') || combinedText.includes('health care'))) {
                        matches = true;
                    } else if (selectedIndustry === 'consulting' && (combinedText.includes('consulting') || combinedText.includes('consultant'))) {
                        matches = true;
                    }
                    
                    if (!matches) return false;
                }
                
                return true;
            });
            
            // Sort by probability (descending)
            filtered.sort((a, b) => {
                const probA = a.probability_of_success ? (a.probability_of_success > 1 ? a.probability_of_success : a.probability_of_success * 100) : 0;
                const probB = b.probability_of_success ? (b.probability_of_success > 1 ? b.probability_of_success : b.probability_of_success * 100) : 0;
                return probB - probA;
            });
            
            window.filteredAdmissionData = filtered;
            
            // Update KPIs based on filtered data and current threshold
            updateAdmissionKPIs(filtered);
            
            renderAdmissionCards(filtered);
        }
        
        // Render admission applicant cards
        function renderAdmissionCards(applicants) {
            const listContainer = document.getElementById('admission-prospects-list');
            if (!listContainer) return;
            
            const titleElement = document.getElementById('admission-prospects-title');
            if (titleElement) {
                titleElement.textContent = `Ranked Candidates (${applicants.length})`;
            }
            
            if (applicants.length === 0) {
                listContainer.innerHTML = `
                    <div style="padding: 3rem; text-align: center; color: rgba(148, 163, 184, 1);">
                        No applicants match your current filters. Adjust the threshold or filter criteria.
                    </div>
                `;
                return;
            }
            
            const cardsHTML = applicants.map((applicant, index) => {
                const name = applicant.name || 'Unknown';
                // Handle probability as percentage (0-100) or decimal (0-1)
                const probValue = applicant.probability_of_success ? parseFloat(applicant.probability_of_success) : 0;
                const probability = probValue > 1 ? probValue.toFixed(1) : (probValue * 100).toFixed(1);
                
                // Calculate decision and risk from probability
                const decision = calculateDecisionFromProbability(applicant.probability_of_success);
                const riskBand = calculateRiskBand(applicant.probability_of_success);
                
                // Extract location, GPA, GRE, and experience
                let location = applicant.location || 'Not specified';
                // Location should already be a state name from backend
                // Just ensure it's clean - if it contains a state name, extract just that
                if (location && location !== 'Not specified' && location.length > 0) {
                    const stateNames = ['New Hampshire', 'New Jersey', 'New Mexico', 'New York', 'North Carolina', 
                                      'North Dakota', 'Rhode Island', 'South Carolina', 'South Dakota', 'West Virginia',
                                      'District of Columbia', 'Alabama', 'Alaska', 'Arizona', 'Arkansas', 'California', 
                                      'Colorado', 'Connecticut', 'Delaware', 'Florida', 'Georgia', 'Hawaii', 'Idaho', 
                                      'Illinois', 'Indiana', 'Iowa', 'Kansas', 'Kentucky', 'Louisiana', 'Maine', 'Maryland', 
                                      'Massachusetts', 'Michigan', 'Minnesota', 'Mississippi', 'Missouri', 'Montana', 
                                      'Nebraska', 'Nevada', 'Ohio', 'Oklahoma', 'Oregon', 'Pennsylvania', 'Tennessee', 
                                      'Texas', 'Utah', 'Vermont', 'Virginia', 'Washington', 'Wisconsin', 'Wyoming'];
                    
                    // Sort by length (longest first) to match multi-word states correctly
                    stateNames.sort((a, b) => b.length - a.length);
                    
                    // Find the first state name in the location string
                    let foundState = null;
                    for (const state of stateNames) {
                        if (location.includes(state)) {
                            foundState = state;
                            break;
                        }
                    }
                    
                    if (foundState) {
                        location = foundState;
                    } else if (location.length === 2) {
                        // If it's a 2-letter abbreviation, convert it
                        location = getFullStateName(location);
                    }
                    // If location is already a valid state name or we couldn't find one, use as is
                }
                
                const gpa = applicant.gpa || null;
                const greScore = applicant.gre_score || null;
                const teachingExp = applicant.teaching_experience_years || null;
                
                // Format experience
                const expDisplay = teachingExp ? `${teachingExp} years exp` : 'Not specified';
                
                // Format GRE score (might be in format like "TOEFL 100 / IELTS 7.7")
                let greDisplay = null;
                if (greScore) {
                    // Try to extract numeric GRE score if it's a simple number, otherwise show as is
                    const greMatch = greScore.toString().match(/(\d+)/);
                    if (greMatch) {
                        greDisplay = `GRE: ${greMatch[1]}`;
                    } else {
                        greDisplay = `GRE: ${greScore}`;
                    }
                }
                
                // Decision badge color
                let decisionColor = '#FF5F5F';
                let decisionText = 'Declined';
                if (decision === 'ADMIT') {
                    decisionColor = '#298E34';
                    decisionText = 'Accepted';
                } else if (decision === 'WAITLIST') {
                    decisionColor = 'rgba(255, 195, 0, 0.9)';
                    decisionText = 'Waitlisted';
                } else if (decision === 'NOT_ADMITTED_INELIGIBLE') {
                    decisionColor = '#FF5F5F';
                    decisionText = 'Not Eligible';
                }
                
                // Build meta info row
                const metaItems = [];
                if (location && location !== 'Not specified') {
                    metaItems.push(location);
                }
                if (gpa) {
                    metaItems.push(`GPA: ${gpa}`);
                }
                if (greDisplay) {
                    metaItems.push(greDisplay);
                }
                if (expDisplay && expDisplay !== 'Not specified') {
                    metaItems.push(expDisplay);
                }
                const metaRow = metaItems.length > 0 ? metaItems.join(' â€¢ ') : 'Information not available';
                
                return `
                    <div class="candidate-card" onclick="window.showAdmissionDetails(${index})" style="cursor: pointer; border-color: ${selectedAdmissionApplicant === index ? 'rgba(75, 155, 255, 0.6)' : 'rgba(75, 155, 255, 0.25)'}; background: #0A3550;">
                        <div class="candidate-card-header">
                            <div class="candidate-card-main">
                                <div class="candidate-info">
                                    <div class="candidate-name-row">
                                        <h4 class="candidate-name" style="color: #4B9BFF;">${escapeHtml(name)}</h4>
                                        <span class="propensity-badge" style="background: rgba(110, 231, 215, 0.15); color: #4B9BFF;">${probability}% success</span>
                                        <span class="propensity-badge" style="background: ${decisionColor}; color: #FFFFFF;">${decisionText}</span>
                                    </div>
                                    <div class="candidate-meta" style="display: flex; flex-wrap: wrap; gap: 0.5rem; color: rgba(255, 255, 255, 0.7); font-size: 1rem; margin-top: 0.5rem;">
                                        ${metaRow}
                                    </div>
                                    <div class="candidate-meta" style="display: flex; flex-wrap: wrap; gap: 0.5rem; color: rgba(255, 255, 255, 0.7); font-size: 0.875rem; margin-top: 0.25rem;">
                                        <span>Risk: ${riskBand}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            listContainer.innerHTML = cardsHTML;
            
            // Re-initialize icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }
        
        // Show admission applicant details
        function showAdmissionDetails(index) {
            const applicants = window.filteredAdmissionData || [];
            if (index < 0 || index >= applicants.length) return;
            
            selectedAdmissionApplicant = index;
            const applicant = applicants[index];
            
            const viewport = document.getElementById('admission-detail-viewport');
            if (!viewport) return;
            
            const rubricScores = applicant.rubric_scores || {};
            const probValue = applicant.probability_of_success ? parseFloat(applicant.probability_of_success) : 0;
            const probability = probValue > 1 ? probValue.toFixed(1) : (probValue * 100).toFixed(1);
            const decision = calculateDecisionFromProbability(applicant.probability_of_success);
            const riskBand = calculateRiskBand(applicant.probability_of_success);
            
            viewport.innerHTML = `
                <div class="candidate-details-view">
                    <div class="candidate-details-header">
                        <h3 style="color: #4B9BFF; margin-bottom: 0.5rem;">${escapeHtml(applicant.name || 'Unknown')}</h3>
                        <p style="color: rgba(148, 163, 184, 1); font-size: 0.9rem; margin-bottom: 1rem;">${applicant.application_id || 'N/A'}</p>
                    </div>
                    
                    <div class="candidate-detail-section">
                        <h4 style="color: #4B9BFF; margin-bottom: 0.5rem;">AI Rationale</h4>
                        <p style="color: rgba(255, 255, 255, 0.8); line-height: 1.6; margin-bottom: 1rem;">${escapeHtml(applicant.ai_rationale || applicant.explanation || 'No rationale available')}</p>
                    </div>
                    
                    <div class="candidate-detail-section">
                        <h4 style="color: #4B9BFF; margin-bottom: 0.5rem;">Scoring Breakdown</h4>
                        <div style="display: grid; gap: 0.5rem; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: rgba(255, 255, 255, 0.8);">Motivation & Values</span>
                                <span style="color: ${rubricScores.motivation_values >= 4 ? '#298E34' : rubricScores.motivation_values >= 3 ? 'rgba(255, 195, 0, 0.9)' : '#94A3B8'}; font-weight: 600;">${rubricScores.motivation_values || 0}/5</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: rgba(255, 255, 255, 0.8);">Resilience</span>
                                <span style="color: ${rubricScores.resilience >= 4 ? '#298E34' : rubricScores.resilience >= 3 ? 'rgba(255, 195, 0, 0.9)' : '#94A3B8'}; font-weight: 600;">${rubricScores.resilience || 0}/5</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: rgba(255, 255, 255, 0.8);">Leadership</span>
                                <span style="color: ${rubricScores.leadership >= 4 ? '#298E34' : rubricScores.leadership >= 3 ? 'rgba(255, 195, 0, 0.9)' : '#94A3B8'}; font-weight: 600;">${rubricScores.leadership || 0}/5</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: rgba(255, 255, 255, 0.8);">Learning Orientation/Fit</span>
                                <span style="color: ${rubricScores.learning_orientation_fit >= 4 ? '#298E34' : rubricScores.learning_orientation_fit >= 3 ? 'rgba(255, 195, 0, 0.9)' : '#94A3B8'}; font-weight: 600;">${rubricScores.learning_orientation_fit || 0}/5</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: rgba(255, 255, 255, 0.8);">Academic Readiness</span>
                                <span style="color: ${rubricScores.academic_readiness >= 4 ? '#298E34' : rubricScores.academic_readiness >= 3 ? 'rgba(255, 195, 0, 0.9)' : '#94A3B8'}; font-weight: 600;">${rubricScores.academic_readiness || 0}/5</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: rgba(255, 255, 255, 0.8);">Life Context</span>
                                <span style="color: ${rubricScores.life_context >= 4 ? '#298E34' : rubricScores.life_context >= 3 ? 'rgba(255, 195, 0, 0.9)' : '#94A3B8'}; font-weight: 600;">${rubricScores.life_context || 0}/5</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="candidate-detail-section">
                        <h4 style="color: #4B9BFF; margin-bottom: 0.5rem;">Assessment Results</h4>
                        <div style="display: grid; gap: 0.5rem; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: rgba(255, 255, 255, 0.8);">Probability of Success</span>
                                <span style="color: #4B9BFF; font-weight: 600;">${probability}%</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: rgba(255, 255, 255, 0.8);">Decision</span>
                                <span style="color: ${decision === 'ADMIT' ? '#298E34' : decision === 'WAITLIST' ? 'rgba(255, 195, 0, 0.9)' : '#FF5F5F'}; font-weight: 600;">${decision}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: rgba(255, 255, 255, 0.8);">Risk Band</span>
                                <span style="color: #4B9BFF; font-weight: 600;">${riskBand}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="candidate-detail-section">
                        <h4 style="color: #4B9BFF; margin-bottom: 0.5rem;">Decision Actions</h4>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <button class="campaign-btn" style="background: rgba(75, 155, 255, 0.85); color: #FFFFFF; width: 100%; padding: 0.75rem;">
                                Proceed with Recommendation
                            </button>
                            <button class="campaign-btn" style="background: transparent; border: 1px solid #4B9BFF; color: #4B9BFF; width: 100%; padding: 0.75rem;">
                                Send to Review
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Re-render cards to update selection highlight
            renderAdmissionCards(applicants);
            
            // Re-initialize icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }
        
        // Download admission CSV
        function downloadAdmissionCSV() {
            if (!window.filteredAdmissionData || window.filteredAdmissionData.length === 0) {
                alert('No admission data available to download.');
                return;
            }
            
            const headers = ['Application ID', 'Name', 'Decision', 'Probability of Success', 'Risk Band'];
            const rows = window.filteredAdmissionData.map(a => {
                const probValue = a.probability_of_success ? parseFloat(a.probability_of_success) : 0;
                const probPercent = probValue > 1 ? probValue.toFixed(2) : (probValue * 100).toFixed(2);
                const decision = calculateDecisionFromProbability(a.probability_of_success);
                const riskBand = calculateRiskBand(a.probability_of_success);
                
                return [
                    a.application_id || '',
                    a.name || '',
                    decision,
                    probPercent + '%',
                    riskBand
                ];
            });
            
            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `admission_results_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }
        
        // Make functions globally available
        window.showAdmissionDetails = showAdmissionDetails;
        window.downloadAdmissionCSV = downloadAdmissionCSV;
        
        // Run admission assessment
        async function runAdmissionAssessment() {
            // Hide form and results, show loading
            document.querySelector('.demo-form-section').style.display = 'none';
            document.getElementById('results-section').style.display = 'none';
            document.getElementById('admissions-section').classList.remove('active');
            document.getElementById('loading-section').style.display = 'block';
            document.getElementById('error-container').innerHTML = '';
            
            // Start loading progress
            startLoadingProgress();
            
            try {
                // Create an AbortController for timeout handling
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30 * 60 * 1000); // 30 minute timeout
                
                const response = await fetch('/api/run-admission', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ num_applications: null, batch_size: 50 }), // Process all applications in batches of 50
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Stop loading progress
                stopLoadingProgress();
                
                // Hide loading
                document.getElementById('loading-section').style.display = 'none';
                
                if (data.success) {
                    // Save results to localStorage
                    localStorage.setItem('udiscovery_admission_results', data.result);
                    localStorage.setItem('udiscovery_admission_timestamp', new Date().toISOString());
                    
                    // Hide loading, show admission results
                    document.getElementById('loading-section').style.display = 'none';
                    document.getElementById('admission-results-section').style.display = 'block';
                    
                    // Display admission results
                    displayAdmissionResults(data.result);
                } else {
                    stopLoadingProgress();
                    // Hide loading, show error but don't show form
                    document.getElementById('loading-section').style.display = 'none';
                    showError(data.error || 'Failed to generate admission assessment results');
                }
            } catch (error) {
                stopLoadingProgress();
                
                // Hide loading, show error
                document.getElementById('loading-section').style.display = 'none';
                
                if (error.name === 'AbortError') {
                    showError('Request timed out. The assessment is taking longer than expected. Please try again or contact support.');
                } else {
                    const errorMsg = error.message.includes('404') 
                        ? 'Server endpoint not found. Please restart the server (npm start) to register the new admission endpoint.'
                        : `Failed to run admission assessment: ${error.message}`;
                    showError(errorMsg);
                }
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            
            // Setup navigation
            setupNavigation();
            
            updateWelcomeMessage();
            restoreSavedData();
            
            // Force select dropdown to match input text color
            const programLevelSelect = document.getElementById('program-level');
            const universityNameInput = document.getElementById('university-name');
            
            if (programLevelSelect && universityNameInput) {
                // Get computed style from input
                const inputStyle = window.getComputedStyle(universityNameInput);
                const inputColor = inputStyle.color;
                
                // Apply same color to select
                programLevelSelect.style.color = inputColor;
                
                // Also set on change events
                programLevelSelect.addEventListener('change', function() {
                    this.style.color = inputColor;
                });
                
                // Force color on focus/blur
                programLevelSelect.addEventListener('focus', function() {
                    this.style.color = inputColor;
                });
                
                programLevelSelect.addEventListener('blur', function() {
                    this.style.color = inputColor;
                });
            }
        });
    </script>
</body>
</html>
